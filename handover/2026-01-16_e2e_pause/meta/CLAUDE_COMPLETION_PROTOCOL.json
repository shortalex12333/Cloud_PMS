{
  "instruction_set": "MICROACTIONS_COMPLETION_PROTOCOL",
  "version": "1.0.0",
  "created": "2026-01-16",
  "mode": "PRODUCTION_DEPLOYMENT",

  "preamble": {
    "context": "You are completing the CelesteOS microactions implementation. Other engineers are actively working on this codebase. Your changes MUST NOT break their work.",
    "mindset": "You are writing production code that will run on live systems. Take your time. Think deeply. Quality over speed.",
    "responsibility": "Every line you write will be reviewed. Every commit will be audited. Act accordingly."
  },

  "execution_rules": {
    "before_any_code_change": [
      "Read the file completely - understand existing patterns",
      "Identify what other code depends on this file",
      "Check git blame to see recent changes by other engineers",
      "Plan your changes mentally before writing"
    ],

    "code_quality_requirements": {
      "comments": {
        "file_header": "Add/update file docstring explaining purpose",
        "function_docstrings": "Every function must have docstring with Args, Returns, Raises",
        "inline_comments": "Explain WHY, not WHAT - complex logic only",
        "todo_format": "# TODO(claude): [description] - Added [date]"
      },
      "naming": {
        "functions": "snake_case, verb_noun format (e.g., get_handlers, validate_input)",
        "classes": "PascalCase, noun format (e.g., TriggerService, HandlerRegistry)",
        "constants": "UPPER_SNAKE_CASE",
        "variables": "Descriptive, no single letters except loops"
      },
      "structure": {
        "max_function_lines": 50,
        "max_file_lines": 500,
        "imports": "Group by stdlib, third-party, local - alphabetized",
        "error_handling": "Always catch specific exceptions, log errors, re-raise if needed"
      }
    },

    "testing_requirements": {
      "before_commit": [
        "Run existing tests to verify no regressions",
        "Add tests for new functionality",
        "Verify edge cases are covered"
      ],
      "commands": {
        "python_tests": "pytest apps/api/tests/ -v",
        "typescript_tests": "npm run test",
        "e2e_tests": "npx playwright test --grep @smoke"
      }
    }
  },

  "git_protocol": {
    "branch_strategy": {
      "rule": "NEVER push directly to main without verification",
      "workflow": [
        "1. Create feature branch: git checkout -b claude/phase-{N}-{description}",
        "2. Make changes with atomic commits",
        "3. Run all tests locally",
        "4. Push feature branch: git push -u origin claude/phase-{N}-{description}",
        "5. Create PR for review OR merge if tests pass"
      ]
    },

    "commit_message_format": {
      "template": "{type}({scope}): {description}\n\n{body}\n\nCo-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>",
      "types": ["feat", "fix", "refactor", "test", "docs", "chore"],
      "scopes": ["handlers", "dispatcher", "triggers", "tests", "ci"],
      "examples": [
        "feat(dispatcher): Register P1/P2/P3 handlers in INTERNAL_HANDLERS",
        "test(visibility): Add button visibility matrix tests for 57 actions",
        "fix(handlers): Add validation for negative quantity in add_wo_part"
      ]
    },

    "merge_protocol": {
      "pre_merge_checklist": [
        "git fetch origin main",
        "git diff origin/main --stat (review what others changed)",
        "git merge origin/main (resolve conflicts carefully)",
        "Run full test suite after merge",
        "Only proceed if ALL tests pass"
      ],
      "conflict_resolution": {
        "rule": "When in doubt, KEEP THE OTHER ENGINEER'S CODE",
        "steps": [
          "Read both versions completely",
          "Understand intent of both changes",
          "If unclear, ask user before resolving",
          "Document resolution in commit message"
        ]
      },
      "post_merge": [
        "git push origin main",
        "Verify CI pipeline passes",
        "Check Render deployment succeeds",
        "Report completion with evidence"
      ]
    }
  },

  "phase_completion_protocol": {
    "after_each_phase": {
      "verification": [
        "Run phase-specific verification from MICROACTIONS_COMPLETION_PLAN.md",
        "Capture evidence (logs, counts, test results)",
        "Document what was done"
      ],
      "git_actions": [
        "Stage changes: git add -p (review each hunk)",
        "Commit with descriptive message",
        "Push to feature branch",
        "Run CI checks"
      ],
      "reporting": {
        "format": "## Phase {N} Complete\n\n### Changes Made\n{list}\n\n### Evidence\n{evidence}\n\n### Tests\n{test_results}\n\n### Next Phase\n{next}"
      }
    },

    "merge_to_main_trigger": {
      "conditions": [
        "All phase tests pass",
        "No TypeScript/Python errors",
        "CI pipeline green",
        "User has been notified of pending merge"
      ],
      "command_sequence": [
        "git checkout main",
        "git pull origin main",
        "git merge claude/phase-{N}-{description} --no-ff",
        "git push origin main"
      ]
    }
  },

  "deep_thinking_triggers": {
    "activate_when": [
      "Modifying dispatcher or routing logic",
      "Changing authentication or authorization",
      "Editing database queries or schemas",
      "Resolving merge conflicts",
      "Writing validation logic",
      "Implementing business rules"
    ],
    "thinking_protocol": {
      "step_1": "State the problem clearly",
      "step_2": "List all affected components",
      "step_3": "Consider edge cases",
      "step_4": "Think about what could break",
      "step_5": "Plan the minimal change needed",
      "step_6": "Write the code",
      "step_7": "Review your own code critically",
      "step_8": "Test before committing"
    }
  },

  "safety_rails": {
    "never_do": [
      "Force push to main: git push --force origin main",
      "Delete branches without asking: git branch -D",
      "Skip tests: --no-verify, pytest -x without running full suite",
      "Modify .env files or secrets",
      "Change database migrations without explicit approval",
      "Remove code you don't understand",
      "Commit console.log or print statements",
      "Commit commented-out code blocks"
    ],
    "always_do": [
      "Read before writing",
      "Test before committing",
      "Pull before pushing",
      "Ask before deleting",
      "Document your changes",
      "Verify CI passes"
    ]
  }
}
