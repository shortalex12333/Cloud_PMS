# Work Order Lens v2 - Acceptance Tests
# ======================================
# Tests for work order pipeline: create, note, parts, complete, reassign, archive
#
# SETUP:
#   export API_BASE=https://pipeline-core.int.celeste7.ai
#   export CREW_JWT="..."    # Crew user JWT (limited permissions)
#   export HOD_JWT="..."     # HOD user JWT (write permissions, e.g., chief_engineer)
#   export CAPTAIN_JWT="..." # Captain user JWT (full permissions including archive)
#   export YACHT_ID="..."    # Test yacht UUID
#
# RUN:
#   httpie/curl or VSCode REST Client
#
# Expected roles:
#   - Crew: READ only + Update/Complete own assigned WOs
#   - HOD: READ + WRITE (create, note, parts, complete, reassign) - is_hod() = chief_engineer, captain, manager
#   - Captain/Manager: Full access including archive (signed)
#
# BLOCKERS RESOLVED (20260125):
#   - B1: pms_work_order_notes RLS fixed (20260125_001)
#   - B2: pms_work_order_parts RLS fixed (20260125_002)
#   - B3: pms_part_usage RLS fixed (20260125_003)
#   - B4: cascade_wo_status_to_fault trigger deployed (20260125_004)


###############################################################################
# TEST 1: List Work Orders (Crew JWT)
###############################################################################
# All crew can view work orders on their yacht
# Expected: 200 OK with work_orders array

GET {{API_BASE}}/api/v1/actions/execute?action=view_work_order_list
Authorization: Bearer {{CREW_JWT}}

###############################################################################
# TEST 2: View Work Order Details (Crew JWT)
###############################################################################
# View single work order details
# Expected: 200 OK with work order data

POST {{API_BASE}}/api/v1/actions/execute
Authorization: Bearer {{CREW_JWT}}
Content-Type: application/json

{
  "action": "view_work_order",
  "context": {
    "yacht_id": "{{YACHT_ID}}"
  },
  "payload": {
    "work_order_id": "<work_order_id>"
  }
}

###############################################################################
# TEST 3: Create Work Order from Fault - HOD (Positive Test)
###############################################################################
# Create work order linked to a fault
# Expected: 200 OK with work_order_id, wo_number

POST {{API_BASE}}/api/v1/actions/execute
Authorization: Bearer {{HOD_JWT}}
Content-Type: application/json

{
  "action": "create_work_order_from_fault",
  "context": {
    "yacht_id": "{{YACHT_ID}}"
  },
  "payload": {
    "fault_id": "<fault_id>",
    "title": "Repair engine coolant leak",
    "equipment_id": "<equipment_id>",
    "location": "Engine Room",
    "description": "Coolant leak detected during routine inspection",
    "priority": "urgent",
    "signature": {
      "user_id": "{{HOD_USER_ID}}",
      "signed_at": "2026-01-25T10:00:00Z"
    }
  }
}

# Expected response:
# {
#   "status": "success",
#   "action": "create_work_order_from_fault",
#   "result": {
#     "work_order": {
#       "id": "<uuid>",
#       "number": "WO-2026-001",
#       "title": "Repair engine coolant leak",
#       "status": "planned"
#     }
#   },
#   "message": "WO-2026-001 created"
# }

###############################################################################
# TEST 4: Create Work Order from Fault - Crew (Negative Test)
###############################################################################
# Crew should NOT be able to create work orders
# Expected: 401/403 Forbidden

POST {{API_BASE}}/api/v1/actions/execute
Authorization: Bearer {{CREW_JWT}}
Content-Type: application/json

{
  "action": "create_work_order_from_fault",
  "context": {
    "yacht_id": "{{YACHT_ID}}"
  },
  "payload": {
    "fault_id": "<fault_id>",
    "title": "Test - Should Fail",
    "equipment_id": "<equipment_id>",
    "priority": "routine",
    "signature": {
      "user_id": "{{CREW_USER_ID}}",
      "signed_at": "2026-01-25T10:00:00Z"
    }
  }
}

# Expected: 401/403 error response

###############################################################################
# TEST 5: Add Note to Work Order - HOD (Positive Test)
###############################################################################
# Add a note to an active work order
# Expected: 200 OK with note_id

POST {{API_BASE}}/api/v1/actions/execute
Authorization: Bearer {{HOD_JWT}}
Content-Type: application/json

{
  "action": "add_note_to_work_order",
  "context": {
    "yacht_id": "{{YACHT_ID}}"
  },
  "payload": {
    "work_order_id": "<work_order_id_from_test_3>",
    "note_text": "Inspected leak source - appears to be a gasket failure",
    "note_type": "progress"
  }
}

# Expected response:
# {
#   "status": "success",
#   "action": "add_note_to_work_order",
#   "result": {
#     "note": {
#       "id": "<uuid>",
#       "work_order_id": "<uuid>",
#       "note_text": "...",
#       "note_type": "progress"
#     }
#   },
#   "message": "Note added to WO-2026-001"
# }

###############################################################################
# TEST 6: Add Note - Yacht Isolation Test
###############################################################################
# User from Yacht A should NOT be able to add note to Yacht B work order
# RLS enforces yacht isolation via parent work order join
#
# This tests B1 fix (20260125_001_fix_cross_yacht_notes.sql)

# Expected: 404 Work Order Not Found (RLS blocks visibility)

###############################################################################
# TEST 7: Add Part to Work Order - HOD (Positive Test)
###############################################################################
# Add a part to work order shopping list (does NOT deduct inventory)
# Expected: 200 OK with work_order_part_id

POST {{API_BASE}}/api/v1/actions/execute
Authorization: Bearer {{HOD_JWT}}
Content-Type: application/json

{
  "action": "add_part_to_work_order",
  "context": {
    "yacht_id": "{{YACHT_ID}}"
  },
  "payload": {
    "work_order_id": "<work_order_id_from_test_3>",
    "part_id": "<part_id>",
    "quantity": 2,
    "notes": "Gasket replacement parts"
  }
}

# Expected response:
# {
#   "status": "success",
#   "action": "add_part_to_work_order",
#   "result": {
#     "work_order_part": {
#       "id": "<uuid>",
#       "part_name": "...",
#       "quantity": 2
#     },
#     "stock_warning": false
#   },
#   "message": "Part added to WO-2026-001"
# }

###############################################################################
# TEST 8: Add Part - Yacht Isolation Test
###############################################################################
# User from Yacht A should NOT be able to add part to Yacht B work order
# RLS enforces yacht isolation via parent work order join
#
# This tests B2 fix (20260125_002_fix_cross_yacht_parts.sql)

# Expected: 404 Work Order Not Found (RLS blocks visibility)

###############################################################################
# TEST 9: Mark Work Order Complete - HOD (Positive Test, with parts deduction)
###############################################################################
# Complete work order and deduct parts from inventory
# Expected: 200 OK with inventory_updates

POST {{API_BASE}}/api/v1/actions/execute
Authorization: Bearer {{HOD_JWT}}
Content-Type: application/json

{
  "action": "mark_work_order_complete",
  "context": {
    "yacht_id": "{{YACHT_ID}}"
  },
  "payload": {
    "work_order_id": "<work_order_id_from_test_3>",
    "completion_notes": "Replaced gasket successfully. Tested for 30 minutes - no leaks observed.",
    "parts_used": [
      {
        "part_id": "<part_id>",
        "quantity_used": 1
      }
    ],
    "signature": {
      "user_id": "{{HOD_USER_ID}}",
      "signed_at": "2026-01-25T14:00:00Z"
    }
  }
}

# Expected response:
# {
#   "status": "success",
#   "action": "mark_work_order_complete",
#   "result": {
#     "work_order": {
#       "id": "<uuid>",
#       "number": "WO-2026-001",
#       "status": "completed",
#       "completed_at": "..."
#     },
#     "inventory_updates": [
#       {
#         "part_name": "...",
#         "quantity_deducted": 1,
#         "previous_stock": 10,
#         "new_stock": 9
#       }
#     ]
#   },
#   "message": "WO-2026-001 marked as complete"
# }

###############################################################################
# TEST 10: Mark Complete - Cascade to Fault Test
###############################################################################
# Verify B4 trigger: WO completed -> Fault resolved
#
# This tests B4 fix (20260125_004_create_cascade_wo_fault_trigger.sql)

# SQL to verify:
# SELECT status, resolved_at, resolved_by
# FROM pms_faults
# WHERE id = '<linked_fault_id>';
# -- Expected: status = 'resolved', resolved_at IS NOT NULL

###############################################################################
# TEST 11: Mark Complete - Already Completed (Negative Test)
###############################################################################
# Cannot complete an already completed work order
# Expected: 400 Bad Request

POST {{API_BASE}}/api/v1/actions/execute
Authorization: Bearer {{HOD_JWT}}
Content-Type: application/json

{
  "action": "mark_work_order_complete",
  "context": {
    "yacht_id": "{{YACHT_ID}}"
  },
  "payload": {
    "work_order_id": "<completed_work_order_id>",
    "completion_notes": "Trying to complete again",
    "parts_used": [],
    "signature": {
      "user_id": "{{HOD_USER_ID}}",
      "signed_at": "2026-01-25T15:00:00Z"
    }
  }
}

# Expected: error_code = "WO_CLOSED", message contains "already completed"

###############################################################################
# TEST 12: Reassign Work Order - HOD (Positive Test, SIGNED)
###############################################################################
# Reassign work order to different crew member
# Expected: 200 OK with previous_assignee_id, new assignee info

POST {{API_BASE}}/api/v1/actions/execute
Authorization: Bearer {{HOD_JWT}}
Content-Type: application/json

{
  "action": "reassign_work_order",
  "context": {
    "yacht_id": "{{YACHT_ID}}"
  },
  "payload": {
    "work_order_id": "<active_work_order_id>",
    "new_assignee_id": "<new_crew_member_id>",
    "reason": "Previous assignee on leave",
    "signature": {
      "user_id": "{{HOD_USER_ID}}",
      "signed_at": "2026-01-25T10:30:00Z",
      "device_id": "web-client"
    }
  }
}

# Expected response:
# {
#   "status": "success",
#   "action": "reassign_work_order",
#   "result": {
#     "work_order": {
#       "id": "<uuid>",
#       "number": "WO-2026-002",
#       "assigned_to": "<new_crew_member_id>",
#       "assigned_to_name": "John Smith"
#     },
#     "previous_assignee_id": "<old_id>",
#     "reason": "Previous assignee on leave"
#   },
#   "message": "WO-2026-002 reassigned to John Smith"
# }

###############################################################################
# TEST 13: Reassign Work Order - Crew (Negative Test)
###############################################################################
# Regular crew cannot reassign work orders
# Expected: 401/403 Forbidden

POST {{API_BASE}}/api/v1/actions/execute
Authorization: Bearer {{CREW_JWT}}
Content-Type: application/json

{
  "action": "reassign_work_order",
  "context": {
    "yacht_id": "{{YACHT_ID}}"
  },
  "payload": {
    "work_order_id": "<active_work_order_id>",
    "new_assignee_id": "<crew_member_id>",
    "reason": "Test",
    "signature": {
      "user_id": "{{CREW_USER_ID}}",
      "signed_at": "2026-01-25T10:30:00Z"
    }
  }
}

# Expected: error_code = "UNAUTHORIZED", message = "Only HOD roles can reassign"

###############################################################################
# TEST 14: Reassign - Completed Work Order (Negative Test)
###############################################################################
# Cannot reassign a completed work order
# Expected: 400 Bad Request

POST {{API_BASE}}/api/v1/actions/execute
Authorization: Bearer {{HOD_JWT}}
Content-Type: application/json

{
  "action": "reassign_work_order",
  "context": {
    "yacht_id": "{{YACHT_ID}}"
  },
  "payload": {
    "work_order_id": "<completed_work_order_id>",
    "new_assignee_id": "<crew_member_id>",
    "reason": "Test",
    "signature": {
      "user_id": "{{HOD_USER_ID}}",
      "signed_at": "2026-01-25T10:30:00Z"
    }
  }
}

# Expected: error_code = "WO_CLOSED", message contains "Cannot reassign"

###############################################################################
# TEST 15: Archive Work Order - Captain (Positive Test, SIGNED)
###############################################################################
# Archive (soft delete) a work order
# Expected: 200 OK with deleted_at, fault returned to open

POST {{API_BASE}}/api/v1/actions/execute
Authorization: Bearer {{CAPTAIN_JWT}}
Content-Type: application/json

{
  "action": "archive_work_order",
  "context": {
    "yacht_id": "{{YACHT_ID}}"
  },
  "payload": {
    "work_order_id": "<active_work_order_id>",
    "deletion_reason": "Duplicate work order - consolidating with WO-2026-005",
    "signature": {
      "user_id": "{{CAPTAIN_USER_ID}}",
      "signed_at": "2026-01-25T16:00:00Z",
      "device_id": "web-client"
    }
  }
}

# Expected response:
# {
#   "status": "success",
#   "action": "archive_work_order",
#   "result": {
#     "work_order": {
#       "id": "<uuid>",
#       "number": "WO-2026-003",
#       "status": "cancelled",
#       "deleted_at": "...",
#       "deletion_reason": "..."
#     },
#     "fault_returned_to_open": true,
#     "linked_fault_id": "<uuid>"
#   },
#   "message": "WO-2026-003 archived"
# }

###############################################################################
# TEST 16: Archive Work Order - Crew (Negative Test)
###############################################################################
# Regular crew cannot archive work orders
# Expected: 401/403 Forbidden

POST {{API_BASE}}/api/v1/actions/execute
Authorization: Bearer {{CREW_JWT}}
Content-Type: application/json

{
  "action": "archive_work_order",
  "context": {
    "yacht_id": "{{YACHT_ID}}"
  },
  "payload": {
    "work_order_id": "<active_work_order_id>",
    "deletion_reason": "Test",
    "signature": {
      "user_id": "{{CREW_USER_ID}}",
      "signed_at": "2026-01-25T16:00:00Z"
    }
  }
}

# Expected: error_code = "UNAUTHORIZED"

###############################################################################
# TEST 17: Archive - Missing Reason (Negative Test)
###############################################################################
# Archive requires deletion_reason
# Expected: 400 Bad Request

POST {{API_BASE}}/api/v1/actions/execute
Authorization: Bearer {{CAPTAIN_JWT}}
Content-Type: application/json

{
  "action": "archive_work_order",
  "context": {
    "yacht_id": "{{YACHT_ID}}"
  },
  "payload": {
    "work_order_id": "<active_work_order_id>",
    "deletion_reason": "",
    "signature": {
      "user_id": "{{CAPTAIN_USER_ID}}",
      "signed_at": "2026-01-25T16:00:00Z"
    }
  }
}

# Expected: error_code = "VALIDATION_ERROR", message contains "at least 5 characters"

###############################################################################
# TEST 18: Archive - Cascade to Fault Test
###############################################################################
# Verify B4 trigger: WO cancelled -> Fault returned to open
#
# This tests B4 cascade for cancelled status

# SQL to verify:
# SELECT status, resolved_at
# FROM pms_faults
# WHERE id = '<linked_fault_id>';
# -- Expected: status = 'open', resolved_at IS NULL

###############################################################################
# TEST 19: Action List - HOD Sees Mutations
###############################################################################
# HOD should see mutation actions for work orders

GET {{API_BASE}}/api/v1/actions/list?domain=work_orders
Authorization: Bearer {{HOD_JWT}}

# Expected: actions array includes:
#   - create_work_order_from_fault (variant: MUTATE)
#   - add_note_to_work_order (variant: MUTATE)
#   - add_part_to_work_order (variant: MUTATE)
#   - mark_work_order_complete (variant: MUTATE)
#   - reassign_work_order (variant: SIGNED)
#   - archive_work_order (variant: SIGNED)

###############################################################################
# TEST 20: Action List - Crew Limited Mutations
###############################################################################
# Crew should NOT see HOD-only mutation actions

GET {{API_BASE}}/api/v1/actions/list?domain=work_orders
Authorization: Bearer {{CREW_JWT}}

# Expected: Should NOT include:
#   - create_work_order_from_fault
#   - reassign_work_order
#   - archive_work_order

###############################################################################
# TEST 21: Audit Log Verification - Non-Signed Actions
###############################################################################
# Verify audit log for non-signed actions has signature = '{}'

# SQL to verify:
# SELECT id, action, entity_type, signature, created_at
# FROM pms_audit_log
# WHERE entity_type = 'work_order'
#   AND action IN ('add_note_to_work_order', 'add_part_to_work_order')
# ORDER BY created_at DESC
# LIMIT 5;
#
# Expected: signature = '{}'::jsonb (empty object, NOT NULL)

###############################################################################
# TEST 22: Audit Log Verification - Signed Actions
###############################################################################
# Verify audit log for signed actions has proper signature payload

# SQL to verify:
# SELECT id, action, signature, created_at
# FROM pms_audit_log
# WHERE entity_type = 'work_order'
#   AND action IN ('reassign_work_order', 'archive_work_order')
# ORDER BY created_at DESC
# LIMIT 5;
#
# Expected: signature contains user_id, signed_at, (optionally device_id)

###############################################################################
# TEST 23: Single-Tenant Yacht Isolation Assertion
###############################################################################
# Verify all work order tables have exactly 1 yacht_id

# SQL to verify:
# SELECT 'pms_work_orders' AS tbl, COUNT(DISTINCT yacht_id) AS n
# FROM pms_work_orders WHERE yacht_id IS NOT NULL
# UNION ALL
# SELECT 'pms_work_order_history', COUNT(DISTINCT yacht_id)
# FROM pms_work_order_history WHERE yacht_id IS NOT NULL
# UNION ALL
# SELECT 'pms_part_usage', COUNT(DISTINCT yacht_id)
# FROM pms_part_usage WHERE yacht_id IS NOT NULL;
#
# Expected: All show n = 1 (or 0 if empty)

###############################################################################
# CLEANUP
###############################################################################
# After tests, clean up test data:
# - DELETE FROM pms_work_order_notes WHERE note_text LIKE 'Test%';
# - DELETE FROM pms_work_order_parts WHERE notes LIKE 'Test%';
# - UPDATE pms_work_orders SET deleted_at = NULL WHERE title LIKE 'Test%';
# - DELETE FROM pms_audit_log WHERE entity_id IN (...);
