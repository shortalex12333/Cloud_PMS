# SECURITY FIX P0-009: CI Secret Scanning Workflow
# This workflow prevents secrets from being committed to the repository.
#
# Created: 2026-01-21
# Updated: 2026-01-28 - Added SBOM, trufflehog, label-gated trigger
# Auditor: Claude B

name: Security Scanning

on:
  push:
    branches: [main, develop, master]
  pull_request:
    branches: [main, develop, master]
  # Also run on PRs with 'security' label
  pull_request_target:
    types: [labeled]

jobs:
  secret-scan:
    name: Secret Scanning
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for gitleaks

      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Check for hardcoded JWT tokens
        run: |
          echo "Checking for hardcoded JWT patterns in source files..."

          # Check for JWT patterns (eyJ... base64 encoded headers)
          if grep -rE "eyJhbGciOiJIUzI1NiIs" \
               --include="*.py" \
               --include="*.ts" \
               --include="*.tsx" \
               --include="*.js" \
               --include="*.jsx" \
               --exclude-dir=node_modules \
               --exclude-dir=.git \
               --exclude-dir=__pycache__ \
               --exclude-dir=.venv \
               . 2>/dev/null; then
            echo ""
            echo "ERROR: Hardcoded JWT tokens found in source files!"
            echo "Remove these tokens and use environment variables instead."
            exit 1
          fi

          echo "No hardcoded JWT tokens detected."

      - name: Check for hardcoded API keys
        run: |
          echo "Checking for hardcoded API key patterns..."

          # Check for OpenAI API keys
          if grep -rE "sk-proj-[a-zA-Z0-9]{20,}" \
               --include="*.py" \
               --include="*.ts" \
               --include="*.tsx" \
               --include="*.js" \
               --include="*.jsx" \
               --exclude-dir=node_modules \
               --exclude-dir=.git \
               --exclude-dir=__pycache__ \
               --exclude-dir=.venv \
               . 2>/dev/null; then
            echo ""
            echo "ERROR: Hardcoded OpenAI API keys found!"
            exit 1
          fi

          # Check for generic secret patterns
          if grep -rE "sk-[a-zA-Z0-9]{48}" \
               --include="*.py" \
               --include="*.ts" \
               --include="*.tsx" \
               --include="*.js" \
               --include="*.jsx" \
               --exclude-dir=node_modules \
               --exclude-dir=.git \
               --exclude-dir=__pycache__ \
               --exclude-dir=.venv \
               . 2>/dev/null; then
            echo ""
            echo "ERROR: Hardcoded API keys found!"
            exit 1
          fi

          echo "No hardcoded API keys detected."

      - name: Check for Supabase service role keys
        run: |
          echo "Checking for Supabase service_role patterns..."

          # Service role keys contain "service_role" in the JWT payload
          if grep -rE '"role":"service_role"' \
               --include="*.py" \
               --include="*.ts" \
               --include="*.tsx" \
               --include="*.js" \
               --include="*.jsx" \
               --exclude-dir=node_modules \
               --exclude-dir=.git \
               --exclude-dir=__pycache__ \
               --exclude-dir=.venv \
               . 2>/dev/null; then
            echo ""
            echo "ERROR: Hardcoded Supabase service_role keys found!"
            exit 1
          fi

          echo "No hardcoded Supabase service keys detected."

      - name: Summary
        run: |
          echo ""
          echo "========================================"
          echo "Security scan completed successfully!"
          echo "========================================"
          echo ""
          echo "Checks passed:"
          echo "  - Gitleaks secret detection"
          echo "  - JWT token pattern check"
          echo "  - API key pattern check"
          echo "  - Supabase service key check"

  # Security Test Suites - Hard gate for PRs
  security-tests:
    name: Security Test Suites
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: apps/api

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: apps/api/requirements.txt

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-asyncio pytest-mock

      - name: Verify secure dispatcher (unsecured handler check)
        run: |
          echo "Verifying all handlers use @secure_action decorator..."
          python -c "
          import sys
          try:
              from action_router.dispatchers.secure_dispatcher import verify_all_handlers_secured
              unsecured = verify_all_handlers_secured()
              if unsecured:
                  print('ERROR: Unsecured handlers detected:')
                  for h in unsecured:
                      print(f'  - {h}')
                  sys.exit(1)
              print('All handlers properly secured.')
          except ImportError:
              print('WARN: secure_dispatcher not found, skipping check')
          except Exception as e:
              print(f'WARN: Could not verify handlers: {e}')
          "

      - name: Run cross-yacht attack tests
        run: |
          echo "Running cross-yacht isolation tests..."
          pytest -v tests/test_cross_yacht_attacks.py --tb=short

      - name: Run streaming safety tests
        run: |
          echo "Running streaming safety tests..."
          pytest -v tests/test_streaming_safety.py tests/test_streaming_cache_isolation.py --tb=short

      - name: Run kill switch tests
        run: |
          echo "Running incident mode / kill switch tests..."
          pytest -v tests/test_kill_switch.py --tb=short

      - name: Run action security tests
        run: |
          echo "Running action router security tests..."
          pytest -v tests/test_action_security.py --tb=short

      - name: Run signed URL security tests
        run: |
          echo "Running signed URL security tests..."
          pytest -v tests/test_signed_url_security.py --tb=short

      - name: Security Test Summary
        if: always()
        run: |
          echo ""
          echo "========================================"
          echo "Security Test Suites Complete"
          echo "========================================"
          echo ""
          echo "Test files executed:"
          echo "  - test_cross_yacht_attacks.py"
          echo "  - test_streaming_safety.py"
          echo "  - test_streaming_cache_isolation.py"
          echo "  - test_kill_switch.py"
          echo "  - test_action_security.py"
          echo "  - test_signed_url_security.py"
          echo ""
          echo "All tests must pass for PR approval."

  # SBOM Generation - Software Bill of Materials
  sbom:
    name: Generate SBOM
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install pip-licenses
        run: |
          pip install pip-licenses

      - name: Generate Python SBOM
        run: |
          echo "Generating Software Bill of Materials..."
          pip install -r apps/api/requirements.txt
          pip-licenses --format=json --output-file=sbom-python.json
          pip-licenses --format=markdown --output-file=sbom-python.md
          echo ""
          echo "SBOM Summary:"
          pip-licenses --summary

      - name: Upload SBOM artifact
        uses: actions/upload-artifact@v4
        with:
          name: sbom-python
          path: |
            sbom-python.json
            sbom-python.md
          retention-days: 90

  # TruffleHog Deep Secrets Scan
  trufflehog-scan:
    name: TruffleHog Secrets Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: TruffleHog OSS
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          extra_args: --only-verified

  # Handler Security Contract
  handler-contract:
    name: Handler Security Contract
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: apps/api
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: apps/api/requirements.txt

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-asyncio pytest-mock

      - name: Run handler security contract tests
        run: |
          echo "Verifying handler security contracts..."
          pytest -v tests/ci/test_handler_security_contract.py --tb=short

      - name: Fail on unsecured handlers at import
        run: |
          echo "Checking for unsecured handlers at module import..."
          python -c "
          import os
          os.environ['STRICT_REGISTRY_VALIDATION'] = 'true'
          try:
              from action_router.dispatchers.secure_dispatcher import SecureDispatcher
              dispatcher = SecureDispatcher(validate_on_init=True, strict=True)
              print('All handlers secured - import check passed')
          except Exception as e:
              print(f'FATAL: Handler security check failed: {e}')
              exit(1)
          "
