name: Inventory Lens Acceptance

on:
  pull_request:
    branches: [main]
    paths:
      - 'apps/api/handlers/part_handlers.py'
      - 'supabase/migrations/202601*_inventory_*.sql'
      - 'tests/inventory_lens/**'
      - '.github/workflows/inventory-lens-acceptance.yml'
  push:
    branches: [main]
    paths:
      - 'apps/api/handlers/part_handlers.py'
      - 'supabase/migrations/202601*_inventory_*.sql'
      - 'tests/inventory_lens/**'
  workflow_dispatch:

jobs:
  acceptance-tests:
    name: Run Inventory Lens Acceptance Tests
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.9
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-asyncio asyncpg python-dotenv

      - name: Build DATABASE_URL
        id: build_db_url
        env:
          TENANT_SUPABASE_URL: ${{ secrets.TENANT_SUPABASE_URL }}
          TENANT_DB_PASSWORD: ${{ secrets.TENANT_DB_PASSWORD }}
        run: |
          # Extract host from TENANT_SUPABASE_URL
          HOST=$(echo "$TENANT_SUPABASE_URL" | sed 's|https://||' | sed 's|http://||')
          # URL-encode password (replace @ with %40)
          ENCODED_PASSWORD=$(echo "$TENANT_DB_PASSWORD" | sed 's/@/%40/g')
          # Build DATABASE_URL
          DATABASE_URL="postgresql://postgres:${ENCODED_PASSWORD}@db.${HOST}:5432/postgres"
          echo "DATABASE_URL=${DATABASE_URL}" >> $GITHUB_OUTPUT
          echo "✅ DATABASE_URL configured"

      - name: Run acceptance tests against staging
        working-directory: tests/inventory_lens
        env:
          DATABASE_URL: ${{ steps.build_db_url.outputs.DATABASE_URL }}
          TEST_YACHT_ID: ${{ secrets.TEST_USER_YACHT_ID }}
          CREW_JWT: ${{ secrets.STAGING_CREW_JWT }}
          HOD_JWT: ${{ secrets.STAGING_HOD_JWT }}
          CAPTAIN_JWT: ${{ secrets.STAGING_CAPTAIN_JWT }}
        run: |
          pytest tests/test_inventory_critical.py \
            -v \
            --tb=short \
            --junit-xml=../../junit-results/inventory-lens-acceptance.xml \
            --junit-prefix=inventory-lens

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: inventory-lens-test-results
          path: junit-results/inventory-lens-acceptance.xml
          retention-days: 30

      - name: Publish test results
        if: always()
        uses: EnricoMi/publish-unit-test-result-action@v2
        with:
          files: junit-results/inventory-lens-acceptance.xml
          check_name: Inventory Lens Acceptance Results
          comment_mode: off

      - name: Upload evidence to docs
        if: github.ref == 'refs/heads/main' && success()
        run: |
          mkdir -p docs/evidence/inventory_item/ci_runs
          cp junit-results/inventory-lens-acceptance.xml \
            docs/evidence/inventory_item/ci_runs/junit_$(date +%Y%m%d_%H%M%S).xml

      - name: Fail if any tests failed
        if: failure()
        run: |
          echo "❌ Inventory Lens acceptance tests FAILED"
          echo "Review test output above for details"
          exit 1

  verify-migrations:
    name: Verify Inventory Migrations Applied
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.9
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      - name: Install asyncpg
        run: pip install asyncpg

      - name: Build DATABASE_URL
        id: build_db_url
        env:
          TENANT_SUPABASE_URL: ${{ secrets.TENANT_SUPABASE_URL }}
          TENANT_DB_PASSWORD: ${{ secrets.TENANT_DB_PASSWORD }}
        run: |
          HOST=$(echo "$TENANT_SUPABASE_URL" | sed 's|https://||' | sed 's|http://||')
          ENCODED_PASSWORD=$(echo "$TENANT_DB_PASSWORD" | sed 's/@/%40/g')
          DATABASE_URL="postgresql://postgres:${ENCODED_PASSWORD}@db.${HOST}:5432/postgres"
          echo "DATABASE_URL=${DATABASE_URL}" >> $GITHUB_OUTPUT

      - name: Verify RLS policies exist
        env:
          DATABASE_URL: ${{ steps.build_db_url.outputs.DATABASE_URL }}
        run: |
          python3 <<EOF
          import asyncio
          import asyncpg
          import os

          async def verify_rls():
              conn = await asyncpg.connect(os.environ['DATABASE_URL'])

              # Check RLS enabled
              tables = await conn.fetch("""
                  SELECT relname, relrowsecurity FROM pg_class
                  WHERE relname IN (
                      'pms_parts',
                      'pms_part_locations',
                      'pms_inventory_stock',
                      'pms_inventory_transactions'
                  )
              """)

              for table in tables:
                  if not table['relrowsecurity']:
                      print(f"❌ RLS not enabled on {table['relname']}")
                      await conn.close()
                      exit(1)
                  print(f"✅ RLS enabled on {table['relname']}")

              # Check policies exist
              policies = await conn.fetch("""
                  SELECT tablename, COUNT(*) as policy_count
                  FROM pg_policies
                  WHERE tablename IN (
                      'pms_parts',
                      'pms_part_locations',
                      'pms_inventory_stock',
                      'pms_inventory_transactions'
                  )
                  GROUP BY tablename
                  ORDER BY tablename
              """)

              expected_counts = {
                  'pms_parts': 3,
                  'pms_part_locations': 3,
                  'pms_inventory_stock': 3,
                  'pms_inventory_transactions': 4,
              }

              for policy in policies:
                  table = policy['tablename']
                  count = policy['policy_count']
                  expected = expected_counts.get(table, 0)
                  if count >= expected:
                      print(f"✅ {table}: {count} policies (expected >= {expected})")
                  else:
                      print(f"❌ {table}: {count} policies (expected >= {expected})")
                      await conn.close()
                      exit(1)

              await conn.close()
              print("✅ All RLS policies verified")

          asyncio.run(verify_rls())
          EOF

      - name: Verify atomic functions exist
        env:
          DATABASE_URL: ${{ steps.build_db_url.outputs.DATABASE_URL }}
        run: |
          python3 <<EOF
          import asyncio
          import asyncpg
          import os

          async def verify_functions():
              conn = await asyncpg.connect(os.environ['DATABASE_URL'])

              functions = [
                  'deduct_stock_inventory',
                  'add_stock_inventory',
                  'transfer_stock_atomic',
                  'is_operational_crew',
                  'is_hod',
                  'is_manager',
              ]

              for func in functions:
                  exists = await conn.fetchval("""
                      SELECT EXISTS (
                          SELECT 1 FROM pg_proc p
                          JOIN pg_namespace n ON p.pronamespace = n.oid
                          WHERE n.nspname = 'public'
                          AND p.proname = \$1
                      )
                  """, func)

                  if exists:
                      print(f"✅ Function {func}() exists")
                  else:
                      print(f"❌ Function {func}() missing")
                      await conn.close()
                      exit(1)

              await conn.close()
              print("✅ All functions verified")

          asyncio.run(verify_functions())
          EOF
