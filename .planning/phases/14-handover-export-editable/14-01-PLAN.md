---
phase: 14
plan: 01
title: External Service Integration + UX Change
wave: 1
autonomous: true
files_modified:
  - apps/web/src/components/handover/HandoverDraftPanel.tsx
  - apps/web/src/lib/handoverExportClient.ts
---

<objective>
Change export button behavior from "Check your email" to calling external handover-export.onrender.com service, with "visible in ledger ~5 minutes" notification.
</objective>

<context>
Current state:
- Export button shows "Check your email" (WRONG)
- Export calls local API at `/v1/handover/export`

Target state:
- Export calls external service → job queued → polling for completion
- Toast shows "Your handover will be visible in ledger when complete (~5 minutes)"
</context>

## Tasks

### Task 1: Create handoverExportClient.ts

Create typed client for external service at `apps/web/src/lib/handoverExportClient.ts`:

```typescript
const EXTERNAL_SERVICE_URL = 'https://handover-export.onrender.com';

interface PipelineRunResponse {
  job_id: string;
  status: 'queued' | 'processing' | 'complete' | 'failed';
}

interface PipelineJobResponse {
  job_id: string;
  status: 'queued' | 'processing' | 'complete' | 'failed';
  result_url?: string;
  error?: string;
}

export async function startExportJob(handoverId: string, yachtId: string): Promise<PipelineRunResponse> {
  const response = await fetch(`${EXTERNAL_SERVICE_URL}/api/pipeline/run`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ handover_id: handoverId, yacht_id: yachtId })
  });
  if (!response.ok) throw new Error('Failed to start export job');
  return response.json();
}

export async function checkJobStatus(jobId: string): Promise<PipelineJobResponse> {
  const response = await fetch(`${EXTERNAL_SERVICE_URL}/api/pipeline/job/${jobId}`);
  if (!response.ok) throw new Error('Failed to check job status');
  return response.json();
}

export async function getReportHtml(jobId: string): Promise<string> {
  const response = await fetch(`${EXTERNAL_SERVICE_URL}/api/pipeline/report/${jobId}`);
  if (!response.ok) throw new Error('Failed to get report');
  return response.text();
}
```

### Task 2: Update HandoverDraftPanel export button

Modify `apps/web/src/components/handover/HandoverDraftPanel.tsx`:

1. Import the new client:
```typescript
import { startExportJob } from '@/lib/handoverExportClient';
```

2. Change the handleExport function:
- Remove the old toast "Check your email"
- Call `startExportJob(handoverId, yachtId)`
- Show toast: "Your handover will be visible in ledger when complete (~5 minutes)"
- Start background polling or rely on backend webhook to create ledger entry

3. Remove call to local `/v1/handover/export` endpoint

### Task 3: Add polling logic (optional - if webhook not available)

If webhook callback isn't set up, add client-side polling:

```typescript
async function pollForCompletion(jobId: string, maxAttempts = 60) {
  for (let i = 0; i < maxAttempts; i++) {
    const status = await checkJobStatus(jobId);
    if (status.status === 'complete') {
      // Trigger ledger notification via API
      await createLedgerNotification(handoverId, jobId);
      return;
    }
    if (status.status === 'failed') {
      toast.error('Export failed. Please try again.');
      return;
    }
    await new Promise(r => setTimeout(r, 5000)); // 5 second intervals
  }
}
```

## Verification

- [ ] Export button no longer shows "Check your email"
- [ ] Export calls external service URL
- [ ] Toast shows "visible in ledger ~5 minutes" message
- [ ] TypeScript compiles with no errors
