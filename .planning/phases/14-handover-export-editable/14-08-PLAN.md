---
phase: 14
plan: 08
title: E2E Tests + Phase Verification
wave: 3
depends_on: [14-04, 14-05, 14-07]
autonomous: true
files_modified:
  - tests/playwright/handover-export-editable.spec.ts
---

<objective>
Create comprehensive E2E tests covering the full handover export editable workflow: export → edit → sign → submit → HOD review → countersign → complete → searchable.
</objective>

<context>
Test the dual-signature workflow:
1. User triggers export → ledger notification
2. User opens in edit mode → edits sections → signs → submits
3. HOD notified → opens in review mode → countersigns
4. Document complete → indexed → searchable
</context>

## Tasks

### Task 1: Create E2E test file

Create `tests/playwright/handover-export-editable.spec.ts`:

```typescript
import { test, expect } from '@playwright/test';
import { loginAs, createTestHandover, getTestUser } from './helpers/auth.helper';

test.describe('Handover Export Editable [HEXPORT]', () => {
  test.describe('Export Flow', () => {
    test('HEXPORT-01: Export button shows ledger notification message', async ({ page }) => {
      await loginAs(page, 'crew');

      // Navigate to handover with draft items
      const handoverId = await createTestHandover(page);
      await page.goto(`/handover/${handoverId}`);

      // Click export button
      await page.getByRole('button', { name: /export/i }).click();

      // Verify toast message
      await expect(page.getByText(/visible in ledger/i)).toBeVisible();
      await expect(page.getByText(/check your email/i)).not.toBeVisible();
    });

    test('HEXPORT-02: Ledger shows export ready notification', async ({ page }) => {
      await loginAs(page, 'crew');

      // Trigger export and wait for completion
      const handoverId = await createTestHandover(page);
      await page.goto(`/handover/${handoverId}`);
      await page.getByRole('button', { name: /export/i }).click();

      // Wait for ledger notification (may take time)
      await page.waitForTimeout(5000);
      await page.goto('/ledger');

      // Find handover export notification
      await expect(page.getByText(/handover export is ready/i)).toBeVisible();
    });
  });

  test.describe('User Edit Mode', () => {
    test('HEXPORT-03: Opens HandoverExportLens from ledger click', async ({ page }) => {
      await loginAs(page, 'crew');

      // Navigate to ledger and click export notification
      await page.goto('/ledger');
      await page.getByText(/handover export is ready/i).click();

      // Verify HandoverExportLens opened
      await expect(page.getByText(/edit mode/i)).toBeVisible();
      await expect(page.locator('[data-lens="handover-export"]')).toBeVisible();
    });

    test('HEXPORT-04: Sections are fully editable in edit mode', async ({ page }) => {
      await loginAs(page, 'crew');

      // Open export lens in edit mode
      await page.goto('/handover-export/test-export-id?mode=edit');

      // Edit section title
      const sectionTitle = page.locator('input[type="text"]').first();
      await sectionTitle.fill('Updated Section Title');

      // Edit section content
      const sectionContent = page.locator('textarea').first();
      await sectionContent.fill('Updated content text');

      // Verify edits persisted
      await expect(sectionTitle).toHaveValue('Updated Section Title');
      await expect(sectionContent).toHaveValue('Updated content text');
    });

    test('HEXPORT-05: Can add new sections', async ({ page }) => {
      await loginAs(page, 'crew');
      await page.goto('/handover-export/test-export-id?mode=edit');

      // Count initial sections
      const initialCount = await page.locator('.handover-section').count();

      // Click add section
      await page.getByText(/add section/i).click();

      // Verify new section added
      const newCount = await page.locator('.handover-section').count();
      expect(newCount).toBe(initialCount + 1);
    });

    test('HEXPORT-06: Can remove sections', async ({ page }) => {
      await loginAs(page, 'crew');
      await page.goto('/handover-export/test-export-id?mode=edit');

      // Count initial sections
      const initialCount = await page.locator('.handover-section').count();

      // Click remove on first section
      await page.getByRole('button', { name: /remove/i }).first().click();

      // Verify section removed
      const newCount = await page.locator('.handover-section').count();
      expect(newCount).toBe(initialCount - 1);
    });

    test('HEXPORT-07: Can reorder sections', async ({ page }) => {
      await loginAs(page, 'crew');
      await page.goto('/handover-export/test-export-id?mode=edit');

      // Get first section title
      const firstTitle = await page.locator('.handover-section h2').first().textContent();

      // Move first section down
      await page.getByRole('button', { name: '↓' }).first().click();

      // First section should now be different
      const newFirstTitle = await page.locator('.handover-section h2').first().textContent();
      expect(newFirstTitle).not.toBe(firstTitle);
    });

    test('HEXPORT-08: Signature canvas captures drawing', async ({ page }) => {
      await loginAs(page, 'crew');
      await page.goto('/handover-export/test-export-id?mode=edit');

      // Find signature canvas
      const canvas = page.locator('canvas');
      await expect(canvas).toBeVisible();

      // Draw on canvas
      const box = await canvas.boundingBox();
      if (box) {
        await page.mouse.move(box.x + 50, box.y + 50);
        await page.mouse.down();
        await page.mouse.move(box.x + 150, box.y + 100);
        await page.mouse.up();
      }

      // Verify clear button appears (indicates signature exists)
      await expect(page.getByText(/clear signature/i)).toBeVisible();
    });

    test('HEXPORT-09: Submit blocked until signed', async ({ page }) => {
      await loginAs(page, 'crew');
      await page.goto('/handover-export/test-export-id?mode=edit');

      // Find submit button
      const submitButton = page.getByRole('button', { name: /finish and submit/i });

      // Should be disabled or show error on click
      await submitButton.click();

      // Verify error toast
      await expect(page.getByText(/must sign/i)).toBeVisible();
    });

    test('HEXPORT-10: Click submit without signature scrolls to signature section', async ({ page }) => {
      await loginAs(page, 'crew');
      await page.goto('/handover-export/test-export-id?mode=edit');

      // Click submit without signing
      await page.getByRole('button', { name: /finish and submit/i }).click();

      // Verify signature section is in view
      const signatureMessage = page.locator('#signature-required-message');
      await expect(signatureMessage).toBeInViewport();
    });
  });

  test.describe('User Submit Flow', () => {
    test('HEXPORT-11: User signature stored after submit', async ({ page }) => {
      await loginAs(page, 'crew');
      await page.goto('/handover-export/test-export-id?mode=edit');

      // Sign the document
      const canvas = page.locator('canvas');
      const box = await canvas.boundingBox();
      if (box) {
        await page.mouse.move(box.x + 50, box.y + 50);
        await page.mouse.down();
        await page.mouse.move(box.x + 150, box.y + 100);
        await page.mouse.up();
      }

      // Submit
      await page.getByRole('button', { name: /finish and submit/i }).click();

      // Verify success
      await expect(page.getByText(/submitted for hod approval/i)).toBeVisible();
    });

    test('HEXPORT-12: Status changes to pending_hod_signature after submit', async ({ page }) => {
      await loginAs(page, 'crew');

      // After successful submit, check status
      await page.goto('/handover-export/test-export-id');

      // Verify status pill
      await expect(page.getByText(/awaiting hod/i)).toBeVisible();
    });

    test('HEXPORT-13: HOD notified via ledger after user submit', async ({ page }) => {
      // Login as HOD
      await loginAs(page, 'hod');
      await page.goto('/ledger');

      // Find countersign notification
      await expect(page.getByText(/requires your countersignature/i)).toBeVisible();
    });
  });

  test.describe('HOD Review Mode', () => {
    test('HEXPORT-14: HOD sees read-only content', async ({ page }) => {
      await loginAs(page, 'hod');
      await page.goto('/handover-export/test-export-id?mode=review');

      // Verify review mode indicator
      await expect(page.getByText(/review mode/i)).toBeVisible();

      // Verify no edit controls
      await expect(page.getByRole('button', { name: /add section/i })).not.toBeVisible();
      await expect(page.getByRole('button', { name: /remove/i })).not.toBeVisible();
    });

    test('HEXPORT-15: User signature visible in review mode', async ({ page }) => {
      await loginAs(page, 'hod');
      await page.goto('/handover-export/test-export-id?mode=review');

      // Find user signature image
      const userSignature = page.locator('img[alt="User signature"]');
      await expect(userSignature).toBeVisible();
    });

    test('HEXPORT-16: HOD countersignature canvas works', async ({ page }) => {
      await loginAs(page, 'hod');
      await page.goto('/handover-export/test-export-id?mode=review');

      // Find HOD signature canvas
      const canvas = page.locator('canvas').last();
      await expect(canvas).toBeVisible();

      // Draw signature
      const box = await canvas.boundingBox();
      if (box) {
        await page.mouse.move(box.x + 50, box.y + 50);
        await page.mouse.down();
        await page.mouse.move(box.x + 150, box.y + 100);
        await page.mouse.up();
      }

      // Verify clear button appears
      await expect(page.getByText(/clear signature/i)).toBeVisible();
    });

    test('HEXPORT-17: Approve blocked until HOD signs', async ({ page }) => {
      await loginAs(page, 'hod');
      await page.goto('/handover-export/test-export-id?mode=review');

      // Try to approve without signing
      await page.getByRole('button', { name: /approve and countersign/i }).click();

      // Verify error
      await expect(page.getByText(/must countersign/i)).toBeVisible();
    });
  });

  test.describe('HOD Countersign Flow', () => {
    test('HEXPORT-18: HOD signature stored after countersign', async ({ page }) => {
      await loginAs(page, 'hod');
      await page.goto('/handover-export/test-export-id?mode=review');

      // Sign
      const canvas = page.locator('canvas').last();
      const box = await canvas.boundingBox();
      if (box) {
        await page.mouse.move(box.x + 50, box.y + 50);
        await page.mouse.down();
        await page.mouse.move(box.x + 150, box.y + 100);
        await page.mouse.up();
      }

      // Approve
      await page.getByRole('button', { name: /approve and countersign/i }).click();

      // Verify success
      await expect(page.getByText(/approved and countersigned/i)).toBeVisible();
    });

    test('HEXPORT-19: Status changes to complete after countersign', async ({ page }) => {
      await loginAs(page, 'hod');
      await page.goto('/handover-export/test-export-id');

      // Verify complete status
      await expect(page.getByText(/complete/i)).toBeVisible();
    });

    test('HEXPORT-20: Embedding worker triggered after countersign', async ({ page }) => {
      // This is verified by checking if document appears in search
      await loginAs(page, 'crew');
      await page.goto('/search');

      // Search for handover content
      await page.getByPlaceholder(/search/i).fill('handover export test');
      await page.keyboard.press('Enter');

      // Verify result appears (may need to wait for indexing)
      await page.waitForTimeout(5000);
      await expect(page.getByText(/handover export/i)).toBeVisible();
    });

    test('HEXPORT-21: Signed handover searchable', async ({ page }) => {
      await loginAs(page, 'crew');
      await page.goto('/search');

      // Search for specific content from the handover
      await page.getByPlaceholder(/search/i).fill('Updated Section Title');
      await page.keyboard.press('Enter');

      // Verify handover export appears in results
      await expect(page.locator('[data-entity-type="handover_export"]')).toBeVisible();
    });
  });
});
```

### Task 2: Create test helpers

Add to `tests/playwright/helpers/auth.helper.ts`:

```typescript
export async function createTestHandover(page: Page): Promise<string> {
  // Create a handover with draft items for testing
  // This would typically call an API to set up test data
  const response = await page.request.post('/api/test/create-handover', {
    data: {
      items: [
        { category: 'critical', content: 'Test critical item' },
        { category: 'action', content: 'Test action item' },
        { category: 'fyi', content: 'Test FYI item' }
      ]
    }
  });

  const { handoverId } = await response.json();
  return handoverId;
}
```

## Verification

- [ ] E2E test file created at tests/playwright/handover-export-editable.spec.ts
- [ ] 21 tests covering full workflow
- [ ] Tests cover: export, edit, sign, submit, HOD review, countersign, search
- [ ] Tests use loginAs helper for role-based testing
- [ ] All tests tagged [HEXPORT] for targeted runs
