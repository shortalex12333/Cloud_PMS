---
phase: 14
plan: 02
title: Database Schema Updates
wave: 1
autonomous: true
files_modified:
  - apps/api/migrations/20260218_handover_export_editable.sql
---

<objective>
Add database columns for two-bucket storage URLs, user/HOD dual signatures, and review status tracking to handover_exports table.
</objective>

<context>
Need to support:
- Two-bucket storage (original AI-generated + user-signed)
- User signature capture
- HOD countersignature capture
- Status tracking through workflow states
</context>

## Tasks

### Task 1: Create migration file

Create `apps/api/migrations/20260218_handover_export_editable.sql`:

```sql
-- Migration: Handover Export Editable with Dual Signatures
-- Phase 14: Enable users to edit and sign handover exports

-- Add storage URL columns
ALTER TABLE handover_exports ADD COLUMN IF NOT EXISTS
  original_storage_url TEXT;

ALTER TABLE handover_exports ADD COLUMN IF NOT EXISTS
  signed_storage_url TEXT;

-- Add edited content storage (JSON structure for sections)
ALTER TABLE handover_exports ADD COLUMN IF NOT EXISTS
  edited_content JSONB;

-- User (creator) signature fields
ALTER TABLE handover_exports ADD COLUMN IF NOT EXISTS
  user_signature JSONB; -- {image_base64, signed_at, signer_name, signer_id}

ALTER TABLE handover_exports ADD COLUMN IF NOT EXISTS
  user_signed_at TIMESTAMPTZ;

ALTER TABLE handover_exports ADD COLUMN IF NOT EXISTS
  user_submitted_at TIMESTAMPTZ;

-- HOD countersignature fields
ALTER TABLE handover_exports ADD COLUMN IF NOT EXISTS
  hod_signature JSONB; -- {image_base64, signed_at, signer_name, signer_id, role}

ALTER TABLE handover_exports ADD COLUMN IF NOT EXISTS
  hod_signed_at TIMESTAMPTZ;

-- Review status tracking
ALTER TABLE handover_exports ADD COLUMN IF NOT EXISTS
  review_status TEXT DEFAULT 'pending_review';

-- Add constraint for valid status values
DO $$
BEGIN
  IF NOT EXISTS (
    SELECT 1 FROM pg_constraint
    WHERE conname = 'handover_exports_review_status_check'
  ) THEN
    ALTER TABLE handover_exports
    ADD CONSTRAINT handover_exports_review_status_check
    CHECK (review_status IN ('pending_review', 'pending_hod_signature', 'complete'));
  END IF;
END $$;

-- Index for HOD pending countersign queries
CREATE INDEX IF NOT EXISTS idx_handover_exports_pending_hod
  ON handover_exports(yacht_id, review_status)
  WHERE review_status = 'pending_hod_signature';

-- Comment on columns for documentation
COMMENT ON COLUMN handover_exports.original_storage_url IS 'Supabase Storage URL for AI-generated HTML (immutable)';
COMMENT ON COLUMN handover_exports.signed_storage_url IS 'Supabase Storage URL for user-edited + signed HTML';
COMMENT ON COLUMN handover_exports.edited_content IS 'JSON structure of user-edited sections before final HTML generation';
COMMENT ON COLUMN handover_exports.user_signature IS 'User signature data: {image_base64, signed_at, signer_name, signer_id}';
COMMENT ON COLUMN handover_exports.hod_signature IS 'HOD countersignature data: {image_base64, signed_at, signer_name, signer_id, role}';
COMMENT ON COLUMN handover_exports.review_status IS 'Workflow status: pending_review → pending_hod_signature → complete';
```

### Task 2: Apply migration via Supabase

Apply migration using Supabase MCP tool or manual execution.

## Verification

- [ ] Migration file created with correct path
- [ ] All columns added: original_storage_url, signed_storage_url, edited_content
- [ ] User signature columns: user_signature, user_signed_at, user_submitted_at
- [ ] HOD signature columns: hod_signature, hod_signed_at
- [ ] review_status column with CHECK constraint
- [ ] Index created for pending_hod_signature queries
