---
phase: 14
plan: 07
title: Ledger Integration + Navigation
wave: 2
depends_on: [14-01]
autonomous: true
files_modified:
  - apps/web/src/components/ledger/LedgerEventCard.tsx
  - apps/web/src/lib/ledgerNavigation.ts
---

<objective>
Wire ledger notifications so users can click to open HandoverExportLens. Create ledger events when export is ready and when HOD countersign is required.
</objective>

<context>
Ledger events:
1. `handover_export_ready` - When HTML generated, user can review
2. `handover_pending_countersign` - When user submits, HOD notified

Click handler opens HandoverExportLens via showContext or navigation.
</context>

## Tasks

### Task 1: Add handover_export to ledger navigation

Update `apps/web/src/lib/ledgerNavigation.ts`:

```typescript
// Add to ENTITY_ROUTES mapping
export const ENTITY_ROUTES: Record<string, (id: string) => string> = {
  // ... existing routes ...
  handover_export: (id) => `/handover-export/${id}`,
};

// Add to getEntityRoute function
export function getEntityRoute(entityType: string, entityId: string): string | null {
  const routeBuilder = ENTITY_ROUTES[entityType];
  if (!routeBuilder) return null;
  return routeBuilder(entityId);
}

// Add click handler helper
export function handleLedgerClick(
  entityType: string,
  entityId: string,
  action?: string,
  router?: ReturnType<typeof useRouter>
) {
  const route = getEntityRoute(entityType, entityId);
  if (!route) return;

  // Add mode param for handover exports based on action
  if (entityType === 'handover_export') {
    if (action === 'requires_countersignature') {
      router?.push(`${route}?mode=review`);
    } else {
      router?.push(`${route}?mode=edit`);
    }
    return;
  }

  router?.push(route);
}
```

### Task 2: Update LedgerEventCard for handover export events

Update `apps/web/src/components/ledger/LedgerEventCard.tsx`:

```typescript
// Add icon mapping
const EVENT_ICONS: Record<string, React.ReactNode> = {
  // ... existing icons ...
  handover_export_ready: <FileTextIcon className="w-4 h-4" />,
  handover_pending_countersign: <PenIcon className="w-4 h-4" />,
};

// Add color mapping
const EVENT_COLORS: Record<string, string> = {
  // ... existing colors ...
  handover_export_ready: 'text-brand-interactive',
  requires_countersignature: 'text-status-warning',
};

// Update click handler in component
function LedgerEventCard({ event }: { event: LedgerEvent }) {
  const router = useRouter();

  const handleClick = () => {
    if (event.entity_type && event.entity_id) {
      handleLedgerClick(
        event.entity_type,
        event.entity_id,
        event.action,
        router
      );
    }
  };

  const isClickable = event.entity_type && event.entity_id &&
    ENTITY_ROUTES[event.entity_type];

  return (
    <div
      className={`p-3 rounded-lg bg-surface-secondary ${isClickable ? 'cursor-pointer hover:bg-surface-tertiary' : ''}`}
      onClick={isClickable ? handleClick : undefined}
      role={isClickable ? 'button' : undefined}
      tabIndex={isClickable ? 0 : undefined}
    >
      <div className="flex items-start gap-3">
        <div className={EVENT_COLORS[event.action] || 'text-txt-secondary'}>
          {EVENT_ICONS[event.event_type] || EVENT_ICONS[event.action] || <CircleIcon className="w-4 h-4" />}
        </div>
        <div className="flex-1">
          <p className="text-sm text-txt-primary">{event.change_summary}</p>
          <p className="text-xs text-txt-tertiary mt-1">
            {formatRelativeTime(event.created_at)}
          </p>
        </div>
        {isClickable && (
          <ChevronRightIcon className="w-4 h-4 text-txt-tertiary" />
        )}
      </div>
    </div>
  );
}
```

### Task 3: Create ledger event when export is ready

Update the export completion flow (in handover_export_routes.py or external service callback):

```python
def create_export_ready_ledger_event(supabase, export_id: str, yacht_id: str, user_id: str, item_count: int):
    """Create ledger event when handover export HTML is ready for review."""
    supabase.table("pms_audit_log").insert({
        "yacht_id": yacht_id,
        "entity_type": "handover_export",
        "entity_id": export_id,
        "action": "export_ready_for_review",
        "event_type": "handover_export_ready",
        "change_summary": "Your handover export is ready for review",
        "user_id": user_id,
        "metadata": {
            "item_count": item_count,
            "status": "pending_review"
        }
    }).execute()
```

### Task 4: Create ledger event for HOD countersign notification

Already implemented in 14-05 `_notify_hod_for_countersign` function, but verify format:

```python
{
    "entity_type": "handover_export",
    "entity_id": export_id,
    "action": "requires_countersignature",
    "event_type": "handover_pending_countersign",
    "change_summary": f"Handover from {user_name} requires your countersignature"
}
```

## Verification

- [ ] ENTITY_ROUTES includes handover_export
- [ ] LedgerEventCard renders handover export events with correct icon
- [ ] Clicking export_ready event opens HandoverExportLens in edit mode
- [ ] Clicking requires_countersignature event opens in review mode
- [ ] Ledger events created at correct workflow points
