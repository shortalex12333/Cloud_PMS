---
phase: 13-gap-remediation
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/20260217000001_shopping_list_state_history.sql
autonomous: true
requirements:
  - SHOP-05

must_haves:
  truths:
    - "Shopping list state_history trigger exists and fires on status changes"
    - "Migration file creates trigger for pms_shopping_list_items"
    - "Trigger inserts into state_history table on INSERT/UPDATE"
  artifacts:
    - path: "supabase/migrations/20260217000001_shopping_list_state_history.sql"
      provides: "State history trigger for shopping list items"
      min_lines: 30
      contains: "CREATE TRIGGER"
  key_links:
    - from: "trigger"
      to: "state_history table"
      via: "INSERT on status change"
      pattern: "INSERT INTO.*state_history|history"
---

<objective>
Create migration to add state_history trigger for shopping list items.

Purpose: Complete SHOP-05 verification gap - shopping list needs state history tracking.
Output: New migration file with trigger for pms_shopping_list_items state changes.
</objective>

<execution_context>
@/Users/celeste7/.claude/get-shit-done/workflows/execute-plan.md
@/Users/celeste7/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create state_history trigger migration</name>
  <files>supabase/migrations/20260217000001_shopping_list_state_history.sql</files>
  <action>
Create a migration file to add state history tracking for shopping list items:

1. Create file: `supabase/migrations/20260217000001_shopping_list_state_history.sql`

2. Migration should:
   a) Create state_history table if not exists (check if pms_audit_log is used instead)
   b) Create trigger function for shopping list state changes
   c) Create trigger on pms_shopping_list_items

3. Implementation:
```sql
-- Shopping List State History Trigger
-- Tracks status changes for audit trail and ledger requirements (SHOP-05)

-- Create trigger function for shopping list state changes
CREATE OR REPLACE FUNCTION track_shopping_list_state_change()
RETURNS TRIGGER AS $$
BEGIN
    -- Only track if status actually changed
    IF TG_OP = 'UPDATE' AND OLD.status IS DISTINCT FROM NEW.status THEN
        INSERT INTO pms_audit_log (
            yacht_id,
            action,
            entity_type,
            entity_id,
            old_values,
            new_values,
            user_id,
            metadata,
            created_at
        ) VALUES (
            NEW.yacht_id,
            'shopping_list_status_change',
            'shopping_list_item',
            NEW.id,
            jsonb_build_object('status', OLD.status),
            jsonb_build_object('status', NEW.status),
            COALESCE(NEW.updated_by, current_setting('request.jwt.claims', true)::json->>'sub'),
            jsonb_build_object(
                'source', 'trigger',
                'trigger_name', TG_NAME,
                'item_name', NEW.name,
                'quantity', NEW.quantity
            ),
            NOW()
        );
    END IF;

    -- Track creation
    IF TG_OP = 'INSERT' THEN
        INSERT INTO pms_audit_log (
            yacht_id,
            action,
            entity_type,
            entity_id,
            old_values,
            new_values,
            user_id,
            metadata,
            created_at
        ) VALUES (
            NEW.yacht_id,
            'shopping_list_item_created',
            'shopping_list_item',
            NEW.id,
            NULL,
            jsonb_build_object('status', NEW.status, 'name', NEW.name, 'quantity', NEW.quantity),
            COALESCE(NEW.created_by, current_setting('request.jwt.claims', true)::json->>'sub'),
            jsonb_build_object(
                'source', 'trigger',
                'trigger_name', TG_NAME
            ),
            NOW()
        );
    END IF;

    RETURN NEW;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Create trigger on pms_shopping_list_items
DROP TRIGGER IF EXISTS shopping_list_state_history_trigger ON pms_shopping_list_items;

CREATE TRIGGER shopping_list_state_history_trigger
    AFTER INSERT OR UPDATE ON pms_shopping_list_items
    FOR EACH ROW
    EXECUTE FUNCTION track_shopping_list_state_change();

-- Add comment for documentation
COMMENT ON TRIGGER shopping_list_state_history_trigger ON pms_shopping_list_items IS
    'Tracks state changes for shopping list items in pms_audit_log for SHOP-05 compliance';
```

4. The trigger writes to pms_audit_log (existing table used by other lenses) not a separate state_history table.

5. Track both INSERT (creation) and UPDATE (status changes).
  </action>
  <verify>
File exists: `ls -la /Volumes/Backup/CELESTE/BACK_BUTTON_CLOUD_PMS/supabase/migrations/20260217000001_shopping_list_state_history.sql`
SQL syntax check: `grep "CREATE TRIGGER" supabase/migrations/20260217000001_shopping_list_state_history.sql`
  </verify>
  <done>Migration file exists with trigger function and CREATE TRIGGER statement for shopping list state history.</done>
</task>

</tasks>

<verification>
1. Migration file exists in supabase/migrations/
2. File contains CREATE TRIGGER statement
3. Trigger function tracks status changes
4. Trigger is attached to pms_shopping_list_items table
</verification>

<success_criteria>
- SHOP-05: State history trigger migration exists for shopping list items
- Trigger tracks both creation and status changes
- Writes to pms_audit_log for consistency with other lenses
</success_criteria>

<output>
After completion, create `.planning/phases/13-gap-remediation-fix-all-failing-requirements-from-verification/13-05-SUMMARY.md`
</output>
