---
phase: 13-gap-remediation
plan: 07
type: execute
wave: 2
depends_on:
  - 13-02
  - 13-03
files_modified:
  - tests/e2e/certificate_lifecycle.spec.ts
  - tests/e2e/warranty_lifecycle.spec.ts
  - supabase/migrations/20260217000002_warranty_ledger_triggers.sql
autonomous: true
requirements:
  - CERT-04
  - WARR-04
  - WARR-05

must_haves:
  truths:
    - "Certificate E2E tests exist and cover full lifecycle"
    - "Warranty E2E tests exist and cover full lifecycle"
    - "Warranty ledger triggers fire on state transitions"
  artifacts:
    - path: "tests/e2e/certificate_lifecycle.spec.ts"
      provides: "Certificate lens E2E tests"
      min_lines: 100
    - path: "tests/e2e/warranty_lifecycle.spec.ts"
      provides: "Warranty lens E2E tests"
      min_lines: 100
    - path: "supabase/migrations/20260217000002_warranty_ledger_triggers.sql"
      provides: "Warranty state change triggers for audit"
      contains: "CREATE TRIGGER"
  key_links:
    - from: "warranty trigger"
      to: "pms_audit_log"
      via: "INSERT on status change"
      pattern: "INSERT INTO.*pms_audit_log"
---

<objective>
Create E2E tests for certificate and warranty lenses, plus warranty ledger triggers.

Purpose: Complete CERT-04 (certificate E2E), WARR-04 (warranty E2E), and WARR-05 (warranty ledger triggers).
Output: Two E2E test files and one migration file.
</objective>

<execution_context>
@/Users/celeste7/.claude/get-shit-done/workflows/execute-plan.md
@/Users/celeste7/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@tests/e2e/user-flows/fault-lifecycle.spec.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create certificate lifecycle E2E tests</name>
  <files>tests/e2e/certificate_lifecycle.spec.ts</files>
  <action>
Create certificate_lifecycle.spec.ts following existing E2E test patterns:

1. Create file: `tests/e2e/certificate_lifecycle.spec.ts`

2. Test coverage per CERT-04:
   - List certificates (vessel and crew)
   - View certificate details
   - Create new certificate
   - Update certificate
   - Find expiring certificates
   - Link document to certificate
   - Supersede certificate (renewal)

3. Implementation pattern following fault-lifecycle.spec.ts:
```typescript
import { test, expect } from '@playwright/test';
import { createAuthenticatedPage, getTestUser } from '../helpers/auth';

test.describe('Certificate Lifecycle', () => {
  test.describe('Vessel Certificates', () => {
    test('HOD can list vessel certificates', async ({ browser }) => {
      const { page, cleanup } = await createAuthenticatedPage(browser, 'hod');

      // Navigate to certificates
      await page.goto('/certificates?type=vessel');
      await expect(page.locator('[data-testid="certificate-list"]')).toBeVisible();

      // Verify certificate card is rendered
      await expect(page.locator('[data-testid="certificate-card"]').first()).toBeVisible();

      await cleanup();
    });

    test('HOD can create vessel certificate', async ({ browser }) => {
      const { page, cleanup } = await createAuthenticatedPage(browser, 'hod');

      await page.goto('/certificates?type=vessel');

      // Click create button
      await page.click('[data-testid="create-certificate-btn"]');

      // Fill form
      await page.fill('[name="certificate_name"]', 'Test Safety Certificate');
      await page.fill('[name="certificate_number"]', 'CERT-001');
      await page.fill('[name="issuing_authority"]', 'Maritime Authority');
      await page.fill('[name="issue_date"]', '2026-01-01');
      await page.fill('[name="expiry_date"]', '2027-01-01');

      // Submit
      await page.click('[data-testid="submit-certificate"]');

      // Verify success
      await expect(page.locator('text=Certificate created')).toBeVisible();

      await cleanup();
    });

    test('Captain can view certificate details', async ({ browser }) => {
      const { page, cleanup } = await createAuthenticatedPage(browser, 'captain');

      await page.goto('/certificates/vessel/test-cert-id');

      // Verify details displayed
      await expect(page.locator('[data-testid="certificate-name"]')).toBeVisible();
      await expect(page.locator('[data-testid="expiry-date"]')).toBeVisible();
      await expect(page.locator('[data-testid="issuing-authority"]')).toBeVisible();

      await cleanup();
    });

    test('System shows expiring certificates warning', async ({ browser }) => {
      const { page, cleanup } = await createAuthenticatedPage(browser, 'hod');

      await page.goto('/certificates?filter=expiring');

      // Verify expiring certificates are highlighted
      await expect(page.locator('[data-testid="expiring-warning"]')).toBeVisible();

      await cleanup();
    });
  });

  test.describe('Crew Certificates', () => {
    test('HOD can list crew certificates', async ({ browser }) => {
      const { page, cleanup } = await createAuthenticatedPage(browser, 'hod');

      await page.goto('/certificates?type=crew');
      await expect(page.locator('[data-testid="certificate-list"]')).toBeVisible();

      await cleanup();
    });

    test('Certificate shows crew member name', async ({ browser }) => {
      const { page, cleanup } = await createAuthenticatedPage(browser, 'hod');

      await page.goto('/certificates/crew/test-cert-id');

      await expect(page.locator('[data-testid="crew-member-name"]')).toBeVisible();

      await cleanup();
    });
  });

  test.describe('Certificate Actions', () => {
    test('HOD can link document to certificate', async ({ browser }) => {
      const { page, cleanup } = await createAuthenticatedPage(browser, 'hod');

      await page.goto('/certificates/vessel/test-cert-id');

      await page.click('[data-testid="link-document-btn"]');

      // Select document
      await page.click('[data-testid="document-select-item"]');
      await page.click('[data-testid="confirm-link"]');

      await expect(page.locator('text=Document linked')).toBeVisible();

      await cleanup();
    });

    test('HOD can supersede certificate', async ({ browser }) => {
      const { page, cleanup } = await createAuthenticatedPage(browser, 'hod');

      await page.goto('/certificates/vessel/test-cert-id');

      await page.click('[data-testid="supersede-btn"]');

      // Fill new certificate details
      await page.fill('[name="new_expiry_date"]', '2028-01-01');
      await page.click('[data-testid="confirm-supersede"]');

      await expect(page.locator('text=Certificate superseded')).toBeVisible();

      await cleanup();
    });
  });

  test.describe('Ledger Verification', () => {
    test('Certificate actions create audit entries', async ({ browser }) => {
      const { page, cleanup } = await createAuthenticatedPage(browser, 'hod');

      await page.goto('/certificates/vessel/test-cert-id');

      // View audit history
      await page.click('[data-testid="view-audit-history"]');

      await expect(page.locator('[data-testid="audit-entry"]')).toBeVisible();

      await cleanup();
    });
  });
});
```

4. Adapt test selectors and URLs to match actual codebase patterns.
  </action>
  <verify>
File exists: `ls -la tests/e2e/certificate_lifecycle.spec.ts`
Test count: `grep -c "test\\(" tests/e2e/certificate_lifecycle.spec.ts`
  </verify>
  <done>certificate_lifecycle.spec.ts exists with E2E tests covering full certificate lifecycle.</done>
</task>

<task type="auto">
  <name>Task 2: Create warranty lifecycle E2E tests and ledger triggers</name>
  <files>tests/e2e/warranty_lifecycle.spec.ts, supabase/migrations/20260217000002_warranty_ledger_triggers.sql</files>
  <action>
Create warranty E2E tests and ledger triggers:

**Part A: warranty_lifecycle.spec.ts**

```typescript
import { test, expect } from '@playwright/test';
import { createAuthenticatedPage } from '../helpers/auth';

test.describe('Warranty Claim Lifecycle', () => {
  test.describe('Draft Phase', () => {
    test('Crew can create warranty claim draft', async ({ browser }) => {
      const { page, cleanup } = await createAuthenticatedPage(browser, 'crew');

      await page.goto('/warranty-claims');
      await page.click('[data-testid="create-claim-btn"]');

      await page.fill('[name="title"]', 'Test Warranty Claim');
      await page.fill('[name="description"]', 'Equipment failed under warranty');
      await page.selectOption('[name="claim_type"]', 'repair');
      await page.fill('[name="vendor_name"]', 'Test Vendor');

      await page.click('[data-testid="save-draft"]');

      await expect(page.locator('text=Draft created')).toBeVisible();

      await cleanup();
    });
  });

  test.describe('Submit Phase', () => {
    test('HOD can submit warranty claim', async ({ browser }) => {
      const { page, cleanup } = await createAuthenticatedPage(browser, 'hod');

      await page.goto('/warranty-claims/test-claim-id');
      await page.click('[data-testid="submit-claim-btn"]');

      await expect(page.locator('text=Claim submitted')).toBeVisible();

      await cleanup();
    });
  });

  test.describe('Approval Phase', () => {
    test('Captain can approve warranty claim with signature', async ({ browser }) => {
      const { page, cleanup } = await createAuthenticatedPage(browser, 'captain');

      await page.goto('/warranty-claims/test-claim-id');
      await page.click('[data-testid="approve-claim-btn"]');

      // Signature prompt should appear
      await expect(page.locator('[data-testid="signature-prompt"]')).toBeVisible();

      await page.click('[data-testid="sign-btn"]');

      await expect(page.locator('text=Claim approved')).toBeVisible();

      await cleanup();
    });

    test('Captain can reject warranty claim', async ({ browser }) => {
      const { page, cleanup } = await createAuthenticatedPage(browser, 'captain');

      await page.goto('/warranty-claims/test-claim-id');
      await page.click('[data-testid="reject-claim-btn"]');

      await page.fill('[name="rejection_reason"]', 'Out of warranty period');
      await page.click('[data-testid="confirm-reject"]');

      await expect(page.locator('text=Claim rejected')).toBeVisible();

      await cleanup();
    });
  });

  test.describe('Ledger Verification', () => {
    test('Warranty actions create audit entries', async ({ browser }) => {
      const { page, cleanup } = await createAuthenticatedPage(browser, 'hod');

      await page.goto('/warranty-claims/test-claim-id');
      await page.click('[data-testid="view-audit-history"]');

      await expect(page.locator('[data-testid="audit-entry"]')).toBeVisible();

      await cleanup();
    });
  });
});
```

**Part B: Warranty ledger triggers migration**

Create `supabase/migrations/20260217000002_warranty_ledger_triggers.sql`:

```sql
-- Warranty Claims Ledger Triggers
-- Tracks state changes for audit trail (WARR-05)

-- Create trigger function for warranty claim state changes
CREATE OR REPLACE FUNCTION track_warranty_claim_state_change()
RETURNS TRIGGER AS $$
BEGIN
    -- Track status changes
    IF TG_OP = 'UPDATE' AND OLD.status IS DISTINCT FROM NEW.status THEN
        INSERT INTO pms_audit_log (
            yacht_id,
            action,
            entity_type,
            entity_id,
            old_values,
            new_values,
            user_id,
            metadata,
            created_at
        ) VALUES (
            NEW.yacht_id,
            'warranty_claim_status_change',
            'warranty_claim',
            NEW.id,
            jsonb_build_object('status', OLD.status),
            jsonb_build_object('status', NEW.status),
            COALESCE(
                NEW.approved_by,
                NEW.submitted_by,
                NEW.drafted_by,
                current_setting('request.jwt.claims', true)::json->>'sub'
            ),
            jsonb_build_object(
                'source', 'trigger',
                'trigger_name', TG_NAME,
                'claim_number', NEW.claim_number,
                'claim_type', NEW.claim_type
            ),
            NOW()
        );
    END IF;

    -- Track creation
    IF TG_OP = 'INSERT' THEN
        INSERT INTO pms_audit_log (
            yacht_id,
            action,
            entity_type,
            entity_id,
            old_values,
            new_values,
            user_id,
            metadata,
            created_at
        ) VALUES (
            NEW.yacht_id,
            'warranty_claim_created',
            'warranty_claim',
            NEW.id,
            NULL,
            jsonb_build_object(
                'status', NEW.status,
                'title', NEW.title,
                'claim_type', NEW.claim_type,
                'claimed_amount', NEW.claimed_amount
            ),
            COALESCE(NEW.drafted_by, current_setting('request.jwt.claims', true)::json->>'sub'),
            jsonb_build_object(
                'source', 'trigger',
                'trigger_name', TG_NAME
            ),
            NOW()
        );
    END IF;

    RETURN NEW;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Create trigger on pms_warranty_claims
DROP TRIGGER IF EXISTS warranty_claim_state_history_trigger ON pms_warranty_claims;

CREATE TRIGGER warranty_claim_state_history_trigger
    AFTER INSERT OR UPDATE ON pms_warranty_claims
    FOR EACH ROW
    EXECUTE FUNCTION track_warranty_claim_state_change();

-- Add comment
COMMENT ON TRIGGER warranty_claim_state_history_trigger ON pms_warranty_claims IS
    'Tracks state changes for warranty claims in pms_audit_log for WARR-05 compliance';
```
  </action>
  <verify>
Test file: `ls -la tests/e2e/warranty_lifecycle.spec.ts`
Migration file: `ls -la supabase/migrations/20260217000002_warranty_ledger_triggers.sql`
Trigger check: `grep "CREATE TRIGGER" supabase/migrations/20260217000002_warranty_ledger_triggers.sql`
  </verify>
  <done>warranty_lifecycle.spec.ts and warranty ledger trigger migration exist.</done>
</task>

</tasks>

<verification>
1. Both E2E test files exist
2. Migration file exists with CREATE TRIGGER
3. Test files have multiple test cases
</verification>

<success_criteria>
- CERT-04: Certificate E2E tests exist covering full lifecycle
- WARR-04: Warranty E2E tests exist covering full lifecycle
- WARR-05: Warranty ledger triggers fire on state transitions
</success_criteria>

<output>
After completion, create `.planning/phases/13-gap-remediation-fix-all-failing-requirements-from-verification/13-07-SUMMARY.md`
</output>
