---
phase: 04-fault
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/api/tests/test_fault_lens_v1.py
  - apps/api/tests/test_fault_lens_v1_evidence.py
autonomous: true
requirements: [FAULT-02, FAULT-05]
must_haves:
  truths:
    - "Crew can execute report_fault, add_fault_note, add_fault_photo"
    - "Crew cannot execute acknowledge_fault, close_fault, diagnose_fault, reopen_fault, mark_fault_false_alarm"
    - "HOD can execute all 9 fault mutation actions"
    - "Captain can execute all 9 fault mutation actions"
    - "Severity mapping works: low->cosmetic, medium->minor, high->major"
    - "Signature invariant enforced: audit_log.signature is NEVER NULL"
    - "Every fault state transition creates pms_audit_log entry"
    - "Ledger metadata includes source, lens, action, entity_type, entity_id"
  artifacts:
    - path: "apps/api/handlers/fault_mutation_handlers.py"
      provides: "9 fault mutation handlers"
      exports: ["report_fault", "acknowledge_fault", "close_fault", "update_fault", "add_fault_photo", "add_fault_note", "diagnose_fault", "reopen_fault", "mark_fault_false_alarm"]
    - path: "apps/api/handlers/fault_handlers.py"
      provides: "5 fault READ handlers"
      exports: ["view_fault", "diagnose_fault", "run_diagnostic", "view_fault_history", "suggest_parts"]
    - path: "apps/api/tests/test_fault_lens_v1.py"
      provides: "Backend handler unit tests"
      min_lines: 200
  key_links:
    - from: "fault_mutation_handlers.py"
      to: "pms_audit_log"
      via: "_create_audit_log method"
      pattern: "_create_audit_log.*signature"
---

<objective>
Verify backend handler tests pass for all user roles and ledger triggers fire correctly.

Purpose: Ensure fault handlers enforce role gating, severity mapping, and audit logging (FAULT-02 + FAULT-05).

Output: Test execution report confirming handler tests pass for all roles and ledger entries are created.
</objective>

<execution_context>
@/Users/celeste7/.claude/get-shit-done/workflows/execute-plan.md
@/Users/celeste7/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/codebase/TESTING.md

# Existing handlers and tests to verify
@apps/api/handlers/fault_mutation_handlers.py
@apps/api/handlers/fault_handlers.py
@apps/api/tests/test_fault_lens_v1.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Run backend handler unit tests and verify role coverage</name>
  <files>apps/api/tests/test_fault_lens_v1.py</files>
  <action>
    Execute the existing handler test suite:
    ```bash
    cd /Volumes/Backup/CELESTE/BACK_BUTTON_CLOUD_PMS
    python -m pytest apps/api/tests/test_fault_lens_v1.py -v --tb=short
    ```

    Verify test coverage includes:
    1. **Severity Mapping Tests**:
       - TestSeverityMapping: valid severities unchanged, legacy mappings work
       - TestSymptomSeverityInference: keyword-based inference works

    2. **Status Transition Tests**:
       - TestStatusTransitions: valid transitions, false_alarm is terminal

    3. **Role-Based Tests** (via mock):
       - Crew: can report, add_note, add_photo
       - Crew: cannot acknowledge, close, update, diagnose
       - HOD/Captain: can execute all actions

    4. **Signature Invariant Tests**:
       - TestSignatureInvariant: signature is {} for non-signed, preserved when provided

    Capture pytest output and any failures.
  </action>
  <verify>`pytest` output shows all tests passing, or failures are documented</verify>
  <done>Backend handler tests executed; all role-based permission checks verified</done>
</task>

<task type="auto">
  <name>Task 2: Verify audit log (ledger) trigger implementation</name>
  <files>apps/api/handlers/fault_mutation_handlers.py</files>
  <action>
    Verify the _create_audit_log method is called by all 9 mutation handlers:
    1. report_fault_execute
    2. acknowledge_fault_execute
    3. close_fault_execute
    4. update_fault_execute
    5. reopen_fault_execute
    6. mark_fault_false_alarm_execute
    7. add_fault_photo_execute
    8. add_fault_note_execute
    9. diagnose_fault_execute

    For each handler, verify:
    - _create_audit_log is called with: yacht_id, action, entity_type="fault", entity_id, user_id
    - signature parameter is passed (never None - invariant)
    - metadata includes: source="lens", lens="faults"

    Document which handlers have correct ledger integration.

    Run grep to verify:
    ```bash
    grep -n "_create_audit_log" apps/api/handlers/fault_mutation_handlers.py
    ```
  </action>
  <verify>All 9 mutation handlers call _create_audit_log with correct parameters</verify>
  <done>Ledger trigger implementation verified; all fault mutations write to pms_audit_log</done>
</task>

<task type="auto">
  <name>Task 3: Verify signature invariant in audit log entries</name>
  <files>apps/api/handlers/fault_mutation_handlers.py, apps/api/tests/test_fault_lens_v1.py</files>
  <action>
    Verify the signature invariant is enforced in _create_audit_log:
    1. Find the method signature and check for `if signature is None: signature = {}`
    2. Verify this is documented in the docstring as "INVARIANT"
    3. Run the signature invariant tests:
       ```bash
       python -m pytest apps/api/tests/test_fault_lens_v1.py::TestSignatureInvariant -v
       ```

    For SIGNED actions (create_work_order_from_fault), verify:
    1. Signature validation method _validate_signature exists
    2. Required fields: signed_at, user_id, role_at_signing, signature_type, signature_hash
    3. signature_type must be "pin_totp"
    4. role_at_signing must be "captain" or "manager"

    Run signature validation tests:
    ```bash
    python -m pytest apps/api/tests/test_fault_lens_v1.py::TestSignatureValidation -v
    ```
  </action>
  <verify>Signature invariant test passes; _create_audit_log never stores None for signature</verify>
  <done>Signature invariant verified; audit log entries always have signature field (empty {} or populated)</done>
</task>

</tasks>

<verification>
- [ ] pytest test_fault_lens_v1.py passes
- [ ] Severity mapping tests pass (low->cosmetic, medium->minor, high->major)
- [ ] Status transition tests pass
- [ ] Signature invariant tests pass
- [ ] All 9 mutation handlers call _create_audit_log
- [ ] Ledger metadata includes source, lens, action
- [ ] Signed action validation tests pass
</verification>

<success_criteria>
FAULT-02 is VERIFIED when:
1. All handler unit tests pass
2. Role-based permission enforcement confirmed via tests
3. All 9 actions callable by HOD/Captain

FAULT-05 is VERIFIED when:
1. All 9 mutation handlers write to pms_audit_log
2. Signature invariant enforced (never NULL)
3. Metadata includes source/lens/action fields
</success_criteria>

<output>
After completion, create `.planning/phases/04-fault/04-02-SUMMARY.md`
</output>
