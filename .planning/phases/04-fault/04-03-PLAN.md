---
phase: 04-fault
plan: 03
type: execute
wave: 2
depends_on: [04-01, 04-02]
files_modified:
  - apps/web/tests/playwright/fault-lens-comprehensive.spec.ts
  - tests/e2e/user-flows/fault-lifecycle.spec.ts
autonomous: false
requirements: [FAULT-03, FAULT-04]
must_haves:
  truths:
    - "FaultCard renders severity (cosmetic|minor|major|critical|safety)"
    - "FaultCard renders status indicator"
    - "FaultCard renders linked equipment name"
    - "FaultCard renders notes section (or link to notes)"
    - "FaultCard renders photos section (or link to photos)"
    - "Captain can search and view faults"
    - "HOD can acknowledge, diagnose, close faults"
    - "Crew can report fault and add notes/photos"
    - "Full lifecycle: report -> acknowledge -> diagnose -> close"
  artifacts:
    - path: "apps/web/src/components/cards/FaultCard.tsx"
      provides: "Fault card component"
      min_lines: 300
      contains: "severity"
    - path: "apps/web/tests/playwright/fault-lens-comprehensive.spec.ts"
      provides: "Comprehensive E2E tests"
      min_lines: 500
  key_links:
    - from: "FaultCard.tsx"
      to: "/api/actions"
      via: "useActionDecisions hook"
      pattern: "useActionDecisions"
    - from: "fault-lens-comprehensive.spec.ts"
      to: "loginAs"
      via: "auth.helper"
      pattern: "loginAs.*captain|hod|crew"
---

<objective>
Verify frontend renders all required fault values and E2E tests cover the full fault lifecycle.

Purpose: Ensure FaultCard displays severity, status, equipment, notes, photos (FAULT-03) and E2E tests cover report->acknowledge->diagnose->close lifecycle (FAULT-04).

Output: Test execution report confirming frontend rendering and E2E lifecycle coverage.
</objective>

<execution_context>
@/Users/celeste7/.claude/get-shit-done/workflows/execute-plan.md
@/Users/celeste7/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/codebase/TESTING.md

# Existing frontend and tests to verify
@apps/web/src/components/cards/FaultCard.tsx
@apps/web/tests/playwright/fault-lens-comprehensive.spec.ts
@tests/e2e/user-flows/fault-lifecycle.spec.ts

# Prior plan summaries needed for context
@.planning/phases/04-fault/04-01-SUMMARY.md
@.planning/phases/04-fault/04-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verify FaultCard renders all required values</name>
  <files>apps/web/src/components/cards/FaultCard.tsx</files>
  <action>
    Review FaultCard.tsx to verify it renders all required fault values:

    1. **Severity** - Check for severity rendering:
       - Look for `severity` prop handling
       - Verify severity badge/dot renders with correct styling
       - Verify all 5 values handled: cosmetic, minor, major, critical, safety
       - (Note: FaultCard uses low/medium/high/critical - verify mapping exists)

    2. **Status** - Check for status indicator:
       - Look for status prop or decision-driven display
       - Verify status transitions shown (open, investigating, work_ordered, resolved, closed)

    3. **Linked Equipment** - Check for equipment display:
       - Look for `equipment_name` rendering
       - Verify it's displayed prominently (secondary text)

    4. **Notes** - Check for notes capability:
       - Look for AddNoteModal integration
       - Verify "Add Note" button conditionally shown

    5. **Photos** - Check for photos capability:
       - Look for AddPhotoModal integration
       - Verify "Add Photo" button conditionally shown

    Document which required values ARE rendered vs missing.
  </action>
  <verify>FaultCard renders: severity badge, status indicator, equipment name, note button, photo button</verify>
  <done>Frontend rendering verified; all required fault values are displayed in FaultCard</done>
</task>

<task type="auto">
  <name>Task 2: Run comprehensive E2E tests and verify role coverage</name>
  <files>apps/web/tests/playwright/fault-lens-comprehensive.spec.ts</files>
  <action>
    Execute the existing Playwright E2E test suite:
    ```bash
    cd /Volumes/Backup/CELESTE/BACK_BUTTON_CLOUD_PMS/apps/web
    npx playwright test fault-lens-comprehensive.spec.ts --reporter=list
    ```

    Verify test coverage includes:
    1. **Captain Success Paths** (Phase 1):
       - Search for active faults
       - View fault details
       - See mutation buttons

    2. **HOD Role Tests** (Phase 3):
       - HOD can search/view faults
       - HOD can acknowledge fault
       - HOD can diagnose fault
       - HOD can close fault

    3. **Crew Role Tests** (Phase 4):
       - Crew can search/view faults
       - Crew CAN report fault
       - Crew CAN add note/photo
       - Crew CANNOT acknowledge/close/diagnose

    4. **Failure Modes** (Phase 5):
       - XSS prevention
       - SQL injection prevention
       - Invalid inputs handled

    Capture test output and document pass/fail counts.
  </action>
  <verify>Playwright tests pass (or failures documented); all 3 roles tested</verify>
  <done>E2E tests executed; Captain/HOD/Crew role coverage verified</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Human verification of fault lens visual rendering</name>
  <files>apps/web/src/components/cards/FaultCard.tsx</files>
  <action>
    Human must verify the visual rendering of the fault lens in the staging environment.

    What was built:
    - Verified fault lens frontend rendering and E2E test coverage
    - FaultCard component renders severity, status, equipment, notes, photos
    - Playwright E2E tests cover all 3 roles (Captain, HOD, Crew)
    - Full lifecycle test coverage exists
  </action>
  <verify>
    How to verify:
    1. Open app at staging URL
    2. Login as Captain (x@alex-short.com)
    3. Search for "fault" in spotlight
    4. Click on a fault result
    5. Verify you see:
       - Severity badge (Critical/High/Medium/Low)
       - Status indicator
       - Equipment name
       - Action buttons (Diagnose, Add Note, Add Photo, Create Work Order)
    6. Login as Crew and verify:
       - Can see faults
       - Can click "Report Fault"
       - Cannot see "Acknowledge" or "Close" buttons
  </verify>
  <done>Type "approved" or describe specific rendering issues found</done>
</task>

</tasks>

<verification>
- [ ] FaultCard renders severity badge with correct styling
- [ ] FaultCard renders status indicator
- [ ] FaultCard renders equipment name
- [ ] FaultCard has Add Note button (conditionally)
- [ ] FaultCard has Add Photo button (conditionally)
- [ ] Playwright tests pass (56+ tests)
- [ ] Captain, HOD, Crew roles all tested
- [ ] Failure mode tests pass (XSS, SQL injection)
- [ ] Human verification confirms visual rendering
</verification>

<success_criteria>
FAULT-03 is VERIFIED when:
1. FaultCard renders all required values: severity, status, equipment, notes, photos
2. Action buttons show/hide based on server decisions
3. Human verification confirms visual correctness

FAULT-04 is VERIFIED when:
1. E2E tests cover report -> acknowledge -> diagnose -> close lifecycle
2. Photo upload tested
3. Note addition tested
4. All 3 roles tested for correct permissions
</success_criteria>

<output>
After completion, create `.planning/phases/04-fault/04-03-SUMMARY.md`
</output>
