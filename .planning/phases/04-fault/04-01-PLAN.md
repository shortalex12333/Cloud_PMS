---
phase: 04-fault
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - tests/docker/run_faults_rls_tests.py
  - apps/api/tests/test_fault_lens_v1.py
autonomous: true
requirements: [FAULT-01]
must_haves:
  truths:
    - "pms_faults table has RLS enabled"
    - "SELECT policy allows crew to view own yacht faults"
    - "INSERT policy allows crew to report faults"
    - "UPDATE policy restricts to HOD+ roles"
    - "No DELETE policy exists (doctrine: faults never deleted)"
    - "Foreign key to pms_equipment is enforced"
    - "pms_fault_notes and pms_attachments have correct RLS"
  artifacts:
    - path: "supabase/migrations/20260127_fix_faults_rls.sql"
      provides: "RLS policies for pms_faults"
      contains: "crew_select_own_yacht_faults"
    - path: "tests/docker/run_faults_rls_tests.py"
      provides: "Docker RLS test suite"
      exports: ["test_crew_can_report_fault", "test_crew_cannot_close_fault"]
  key_links:
    - from: "pms_faults"
      to: "pms_equipment"
      via: "equipment_id FK"
      pattern: "equipment_id.*REFERENCES.*pms_equipment"
---

<objective>
Verify database schema integrity for the Fault Lens.

Purpose: Ensure pms_faults table has correct RLS policies, FK constraints, and related tables (pms_fault_notes, pms_attachments) are properly configured.

Output: Verification report confirming FAULT-01 requirements met.
</objective>

<execution_context>
@/Users/celeste7/.claude/get-shit-done/workflows/execute-plan.md
@/Users/celeste7/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/codebase/TESTING.md

# Existing artifacts to verify
@supabase/migrations/20260127_fix_faults_rls.sql
@tests/docker/run_faults_rls_tests.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verify pms_faults RLS policies exist and are correct</name>
  <files>supabase/migrations/20260127_fix_faults_rls.sql</files>
  <action>
    Run SQL query against Supabase to verify:
    1. RLS is enabled on pms_faults: `SELECT relrowsecurity FROM pg_class WHERE relname = 'pms_faults';`
    2. Three policies exist (SELECT, INSERT, UPDATE):
       - `crew_select_own_yacht_faults` FOR SELECT
       - `crew_insert_faults` FOR INSERT
       - `hod_update_faults` FOR UPDATE
    3. No DELETE policy exists (per doctrine)

    Use psql via service role or run verification SQL:
    ```sql
    SELECT polname, polcmd FROM pg_policies WHERE tablename = 'pms_faults';
    ```

    Document results in verification output.
  </action>
  <verify>SQL query returns exactly 3 policies: SELECT, INSERT, UPDATE (no DELETE)</verify>
  <done>RLS policies confirmed: crew can SELECT/INSERT, HOD can UPDATE, no DELETE allowed</done>
</task>

<task type="auto">
  <name>Task 2: Verify FK constraints and related table RLS</name>
  <files>supabase/migrations/</files>
  <action>
    Verify foreign key constraints:
    1. pms_faults.equipment_id references pms_equipment(id)
    2. pms_faults.yacht_id references appropriate tenant table

    Verify related tables have RLS:
    1. pms_fault_notes has SELECT/INSERT policies
    2. pms_attachments has SELECT/INSERT policies for fault entity_type

    Run SQL:
    ```sql
    -- Check FK constraints
    SELECT conname, confrelid::regclass as referenced_table
    FROM pg_constraint
    WHERE conrelid = 'pms_faults'::regclass AND contype = 'f';

    -- Check related table RLS
    SELECT tablename, policyname FROM pg_policies
    WHERE tablename IN ('pms_fault_notes', 'pms_attachments');
    ```
  </action>
  <verify>FK to pms_equipment exists; pms_fault_notes and pms_attachments have RLS policies</verify>
  <done>FK constraints verified; related tables have appropriate RLS policies</done>
</task>

<task type="auto">
  <name>Task 3: Run existing RLS test suite and document results</name>
  <files>tests/docker/run_faults_rls_tests.py</files>
  <action>
    Execute the existing Docker RLS test suite:
    ```bash
    cd /Volumes/Backup/CELESTE/BACK_BUTTON_CLOUD_PMS
    python tests/docker/run_faults_rls_tests.py
    ```

    If Docker is not available, run individual test assertions by:
    1. Reviewing test file for expected behaviors
    2. Documenting which tests cover FAULT-01 requirements:
       - test_crew_can_report_fault (INSERT policy)
       - test_crew_cannot_close_fault (UPDATE policy denied for crew)
       - test_engineer_can_acknowledge (UPDATE policy for engineer+)
       - test_invalid_fault_returns_4xx (error mapping)

    Capture test output and any failures.
  </action>
  <verify>RLS tests pass or failures are documented with specific policy issues</verify>
  <done>RLS test suite executed; results documented showing policy enforcement working correctly</done>
</task>

</tasks>

<verification>
- [ ] pms_faults has RLS enabled
- [ ] SELECT policy: crew_select_own_yacht_faults exists
- [ ] INSERT policy: crew_insert_faults exists
- [ ] UPDATE policy: hod_update_faults exists
- [ ] No DELETE policy (confirmed absent)
- [ ] FK constraint to pms_equipment verified
- [ ] pms_fault_notes has RLS
- [ ] pms_attachments has RLS
- [ ] Docker RLS tests pass (or failures documented)
</verification>

<success_criteria>
FAULT-01 is VERIFIED when:
1. All three RLS policies are confirmed present and correctly scoped
2. No DELETE policy exists
3. FK constraints are enforced
4. Related tables (notes, attachments) have appropriate RLS
5. RLS test suite passes or issues are documented
</success_criteria>

<output>
After completion, create `.planning/phases/04-fault/04-01-SUMMARY.md`
</output>
