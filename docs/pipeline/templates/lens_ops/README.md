# Lens Ops Template

**Purpose:** Repeatable, auditable, evidence-driven deployment and monitoring for all CelesteOS lenses

**Status:** Production-grade template (v1.0)

---

## Why This Exists

### Problem
During Fault Lens v1 canary deployment, we relied on ad-hoc scratchpad scripts for:
- Manual health checks every 1-2 hours
- Manual smoke tests before each rollout phase
- Manual stress testing before deployment
- One-off idempotency verification

**Risks:**
- Human error (forgetting to check, misreading outputs)
- No audit trail (who checked what when)
- Not repeatable (tribal knowledge)
- Doesn't scale (20 lenses × 4 phases = 80 manual checks)

### Solution
A **Lens Ops Template** that provides:
1. **Automated health monitoring** via Render background worker (DB-backed, observable)
2. **CI-driven acceptance tests** (pre-deploy, post-deploy smoke, nightly stress)
3. **Evidence artifacts** (raw HTTP transcripts, percentiles, audit logs)
4. **Feature flags discipline** (fail-closed, 503 when OFF, documented rollback)
5. **Reusability** (instantiate for any lens: faults, certificates, equipment, parts, etc.)

### Benefits
- **Reliability:** Automated checks catch issues before humans notice
- **Auditability:** All checks logged to `pms_health_checks` table with timestamps
- **Speed:** Canary → production in hours, not days (confidence from automation)
- **Scalability:** New lens = 5-minute instantiation, not 2 days of script writing

---

## How It Works

### Template Parameters

Each lens defines:
- **LENS_ID:** Unique identifier (e.g., `faults`, `certificates`, `equipment`)
- **DOMAIN:** Action router domain (e.g., `faults`, `certificates`)
- **FEATURE_FLAGS:** List of flags (e.g., `FAULT_LENS_V1_ENABLED`, `FAULT_LENS_SUGGESTIONS_ENABLED`)
- **CANON_ROLES:** Roles for testing (e.g., `crew`, `chief_engineer`, `captain`, `manager`)
- **CRITICAL_ENDPOINTS:** Endpoints to monitor (e.g., `/v1/actions/list?domain=faults`)

### Template Components

```
docs/pipeline/templates/lens_ops/
├── README.md (this file)
├── FEATURE_FLAGS_TEMPLATE.md (feature flag doc template)
├── EVIDENCE_TEMPLATE.md (evidence structure)
├── health_worker_template.py (Render background worker)
├── acceptance_test_template.py (CI acceptance tests)
├── stress_test_template.py (CI stress tests)
├── idempotency_test_template.sql (DB constraint verification)
└── ci_workflow_templates/
    ├── acceptance.yml (GitHub Actions workflow)
    ├── stress.yml (nightly stress workflow)
    └── idempotency.yml (schema change workflow)

tools/ops/monitors/
├── create_lens_ops_template.py (generator script)
└── {LENS_ID}_health_worker.py (instantiated workers)
```

### Instantiation Methods

**Method 1: Generator Script (Recommended)**
```bash
python3 tools/ops/monitors/create_lens_ops_template.py \
  --lens-id faults \
  --domain faults \
  --feature-flags FAULT_LENS_V1_ENABLED,FAULT_LENS_SUGGESTIONS_ENABLED,FAULT_LENS_SIGNED_ACTIONS_ENABLED \
  --roles crew,chief_engineer,chief_officer,captain,manager \
  --output-dir .
```

**Method 2: Manual Copy**
1. Copy template files to target locations
2. Replace `{LENS_ID}`, `{DOMAIN}`, `{FEATURE_FLAGS}` placeholders
3. Update test data (user IDs, yacht IDs, entity IDs)
4. Deploy worker to Render, enable workflows in GitHub

---

## Non-Negotiable Testing Doctrine

All tests generated by this template adhere to CelesteOS testing doctrine:

### 1. Expected 4xx is Success (When Asserted)
**Cite:** `/Volumes/Backup/CELESTE/testing_success_ci:cd.md:799`

> **Role denial asserts 403 (crew mutations):** When testing role gating, a 403 response for unauthorized roles (e.g., CREW attempting SIGNED action) is a **PASS**, not a failure.

**Implementation:**
```python
# Test: CREW attempts SIGNED action
status, body = execute_action("create_work_order_from_fault", crew_jwt, payload)
assert status == 403, f"Expected 403, got {status}"  # ✅ PASS
assert body["error_code"] == "invalid_signer_role"
```

### 2. 500 is Always Failure
**Cite:** `/Volumes/Backup/CELESTE/testing_success_ci:cd.md:249`

> **500 indicates bug in contracts:** A 500 error always indicates a bug—whether in validation, error handling, or contract enforcement. Stress tests **must report 0×500** to pass.

**Implementation:**
```python
# Stress test verdict
if status_5xx_count > 0:
    verdict = "FAIL"
    reason = f"{status_5xx_count}×500 errors detected (hard requirement: 0×500)"
else:
    verdict = "PASS"
```

### 3. Facilities Produce Tangible Artifacts
**Cite:** `/Volumes/Backup/CELESTE/testing_success_ci:cd.md:815`

> **Evidence table types:** Tests must capture raw HTTP transcripts, status codes, response bodies, before/after DB state—not just "test passed" assertions.

**Implementation:**
```python
# Capture full HTTP transcript
transcript = f"""
POST /v1/actions/execute HTTP/1.1
Authorization: Bearer {jwt[:20]}...
Content-Type: application/json

{json.dumps(payload, indent=2)}

HTTP/1.1 {status} {reason}
Content-Type: application/json

{json.dumps(body, indent=2)}
"""
evidence.append(transcript)
```

### 4. Stress Verdict Thresholds
**Cite:** `/Volumes/Backup/CELESTE/testing_success_ci:cd.md:708`

> **Success rate, P95:** Stress tests must report P50/P95/P99 latencies and overall success rate. Verdict: PASS if 0×500 (hard requirement).

**Implementation:**
```python
# Compute percentiles
p50 = statistics.median(latencies)
p95 = latencies[int(len(latencies) * 0.95)]
p99 = latencies[int(len(latencies) * 0.99)]

# Verdict
verdict = "PASS" if status_5xx_count == 0 else "FAIL"
```

---

## Template Deliverables

### 1. Health Worker (Render Background Service)

**Path:** `tools/ops/monitors/{LENS_ID}_health_worker.py`

**What it does:**
- Runs every N minutes (configurable via env var `HEALTH_CHECK_INTERVAL_MINUTES`)
- Probes critical endpoints:
  - Health endpoint (`/v1/actions/health`)
  - Feature flags (via Render API)
  - Suggestions endpoint (`/v1/actions/suggestions`)
  - Execute endpoint (READ variant, safe)
- Writes results to `pms_health_checks` table (yacht-scoped, RLS)
- Emits structured logs for observability
- Optional: Exposes `/metrics` endpoint for Prometheus

**DB Tables:**
```sql
-- Health check results
CREATE TABLE pms_health_checks (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
    yacht_id uuid NOT NULL,
    lens_id text NOT NULL,
    status text NOT NULL,  -- 'healthy', 'degraded', 'unhealthy'
    p95_latency_ms integer,
    error_rate_percent numeric(5,2),
    sample_size integer,
    observed_at timestamp with time zone NOT NULL DEFAULT now(),
    notes jsonb DEFAULT '{}'::jsonb,
    CONSTRAINT fk_yacht FOREIGN KEY (yacht_id)
        REFERENCES yacht_registry(id) ON DELETE CASCADE
);

-- Health events (detailed logs)
CREATE TABLE pms_health_events (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
    check_id uuid NOT NULL,
    level text NOT NULL,  -- 'info', 'warning', 'error'
    detail_json jsonb NOT NULL,
    created_at timestamp with time zone NOT NULL DEFAULT now(),
    CONSTRAINT fk_check FOREIGN KEY (check_id)
        REFERENCES pms_health_checks(id) ON DELETE CASCADE
);
```

**Render Service Configuration:**
```yaml
# render.yaml
services:
  - type: worker
    name: {LENS_ID}-health-worker
    env: python
    buildCommand: pip install -r requirements.txt
    startCommand: python tools/ops/monitors/{LENS_ID}_health_worker.py
    envVars:
      - key: HEALTH_CHECK_INTERVAL_MINUTES
        value: 15
      - key: TENANT_SUPABASE_URL
        sync: false
      - key: TENANT_SUPABASE_JWT_SECRET
        sync: false
      - key: RENDER_API_KEY
        sync: false
```

**Output:**
```
[2026-01-28T15:00:00Z] INFO: Starting health check for lens=faults yacht=85fe1119-...
[2026-01-28T15:00:01Z] INFO: Health endpoint: ✅ HEALTHY (4/4 handlers)
[2026-01-28T15:00:02Z] INFO: Feature flags: ✅ ENABLED (FAULT_LENS_V1_ENABLED=true)
[2026-01-28T15:00:03Z] INFO: Suggestions endpoint: ✅ 200 OK (12 actions, 867ms)
[2026-01-28T15:00:04Z] INFO: Execute endpoint: ✅ 200 OK (1523ms)
[2026-01-28T15:00:05Z] INFO: Writing result to pms_health_checks: status=healthy p95=1523ms
[2026-01-28T15:00:05Z] INFO: Sleeping for 15 minutes...
```

---

### 2. CI Workflows (GitHub Actions)

**Paths:**
- `.github/workflows/{LENS_ID}-staging-acceptance.yml`
- `.github/workflows/{LENS_ID}-stress.yml`
- `.github/workflows/{LENS_ID}-idempotency.yml`

**Workflow 1: Staging Acceptance (Pre-Deploy, Post-Deploy)**
```yaml
name: {LENS_ID} - Staging Acceptance

on:
  push:
    branches: [main]
    paths:
      - 'apps/api/handlers/{LENS_ID}_*.py'
      - 'apps/api/routes/{LENS_ID}_*.py'
      - 'tests/ci/{LENS_ID}_*.py'
  workflow_dispatch:

jobs:
  acceptance:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - run: pip install -r requirements.txt
      - name: Run Acceptance Tests
        env:
          STAGING_API_URL: https://pipeline-core.int.celeste7.ai
          STAGING_JWT_SECRET: ${{ secrets.STAGING_JWT_SECRET }}
        run: python3 tests/ci/{LENS_ID}_signed_flow_acceptance.py
      - name: Upload Evidence
        uses: actions/upload-artifact@v3
        with:
          name: {LENS_ID}-acceptance-evidence
          path: verification_handoff/phase*/
```

**Workflow 2: Stress Testing (Nightly)**
```yaml
name: {LENS_ID} - Stress Testing

on:
  schedule:
    - cron: '0 2 * * *'  # 2 AM daily
  workflow_dispatch:

jobs:
  stress:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - run: pip install -r requirements.txt
      - name: Run Stress Tests
        env:
          STAGING_API_URL: https://pipeline-core.int.celeste7.ai
          STAGING_JWT_SECRET: ${{ secrets.STAGING_JWT_SECRET }}
        run: python3 tests/stress/{LENS_ID}_actions_endpoints.py
      - name: Upload Results
        uses: actions/upload-artifact@v3
        with:
          name: {LENS_ID}-stress-results
          path: verification_handoff/phase*/*STRESS*.md
```

**Workflow 3: Idempotency (On Schema Change)**
```yaml
name: {LENS_ID} - Idempotency Check

on:
  push:
    paths:
      - 'migrations/{LENS_ID}_*.sql'
      - 'apps/api/handlers/{LENS_ID}_notification_*.py'
  workflow_dispatch:

jobs:
  idempotency:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - run: pip install -r requirements.txt
      - name: Run Idempotency Tests
        env:
          STAGING_DB_URL: ${{ secrets.STAGING_DB_URL }}
        run: python3 tests/ci/{LENS_ID}_idempotency_test.py
      - name: Upload Evidence
        uses: actions/upload-artifact@v3
        with:
          name: {LENS_ID}-idempotency-evidence
          path: verification_handoff/phase*/*IDEMPOTENCY*.md
```

---

### 3. Test Templates

**Path:** `tests/ci/{LENS_ID}_signed_flow_acceptance.py`

**What it tests:**
1. Missing signature → 400 signature_required
2. Invalid signature structure → 400 invalid_signature
3. CREW attempts SIGNED action → 403 invalid_signer_role (PASS, not fail)
4. CAPTAIN valid signature → 200 + entity created
5. HOD (manager) valid signature → 200 + entity created
6. Audit log verification → signature NOT NULL with canonical payload

**Evidence produced:**
- Full HTTP transcripts (request + response)
- Before/after DB queries
- Status code verification (400/400/403/200)
- Audit log JSON

---

### 4. Feature Flags Documentation

**Path:** `docs/pipeline/{LENS_ID}_FEATURE_FLAGS.md`

**Contents:**
- Master flag: `{LENS_ID}_V1_ENABLED` (default: `false`)
- Individual flags: `{LENS_ID}_SUGGESTIONS_ENABLED`, `{LENS_ID}_SIGNED_ACTIONS_ENABLED`, etc.
- 503 FEATURE_DISABLED behavior when OFF
- Toggle/rollback procedures
- Canary rollout plan (staging canary → staging full → prod canary → prod 100%)

---

### 5. Evidence Template

**Path:** `verification_handoff/phase{N}/{LENS_ID}_EVIDENCE.md`

**Sections:**
1. Integration Tests (signed flow 400/400/403/200)
2. Stress Tests (0×500 + percentiles)
3. Notifications Idempotency (DDL + duplicate proof)
4. Feature Flags Proof (OFF=503, ON=200)
5. Scripts Reference (what, why, when)

---

## Instantiation Example: Parts Lens

Let's instantiate the template for a hypothetical "Parts Lens v2":

### Step 1: Define Parameters
```yaml
LENS_ID: parts
DOMAIN: parts
FEATURE_FLAGS:
  - PARTS_LENS_V2_ENABLED
  - PARTS_LENS_SUGGESTIONS_ENABLED
  - PARTS_LENS_SIGNED_ACTIONS_ENABLED
CANON_ROLES:
  - crew
  - chief_engineer
  - chief_officer
  - captain
  - purser
  - manager
CRITICAL_ENDPOINTS:
  - /v1/actions/list?domain=parts
  - /v1/actions/suggestions (domain=parts)
  - /v1/actions/execute (action=order_part)
```

### Step 2: Run Generator
```bash
python3 tools/ops/monitors/create_lens_ops_template.py \
  --lens-id parts \
  --domain parts \
  --feature-flags PARTS_LENS_V2_ENABLED,PARTS_LENS_SUGGESTIONS_ENABLED,PARTS_LENS_SIGNED_ACTIONS_ENABLED \
  --roles crew,chief_engineer,chief_officer,captain,purser,manager \
  --output-dir .
```

### Step 3: Generated Files
```
✅ tools/ops/monitors/parts_health_worker.py
✅ tests/ci/parts_signed_flow_acceptance.py
✅ tests/stress/parts_actions_endpoints.py
✅ .github/workflows/parts-staging-acceptance.yml
✅ .github/workflows/parts-stress.yml
✅ docs/pipeline/PARTS_FEATURE_FLAGS.md
✅ verification_handoff/phase6/PARTS_EVIDENCE_TEMPLATE.md
```

### Step 4: Deploy
1. Add Render worker service for `parts_health_worker.py`
2. Enable GitHub workflows
3. Run acceptance tests (should PASS with 0×500)
4. Monitor via `pms_health_checks` table

### Step 5: Canary Rollout
1. Enable flags on staging canary
2. Monitor 24h (automated via health worker)
3. If green, proceed to staging full
4. If green, proceed to prod canary
5. Gradual rollout to 100%

---

## DB Schema (Optional)

**Path:** `migrations/ops_health_tables.sql`

```sql
-- Health check results (RLS-scoped by yacht_id)
CREATE TABLE IF NOT EXISTS pms_health_checks (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
    yacht_id uuid NOT NULL,
    lens_id text NOT NULL,
    status text NOT NULL CHECK (status IN ('healthy', 'degraded', 'unhealthy')),
    p95_latency_ms integer,
    error_rate_percent numeric(5,2),
    sample_size integer,
    observed_at timestamp with time zone NOT NULL DEFAULT now(),
    notes jsonb DEFAULT '{}'::jsonb,
    CONSTRAINT fk_yacht FOREIGN KEY (yacht_id)
        REFERENCES yacht_registry(id) ON DELETE CASCADE
);

CREATE INDEX idx_health_checks_yacht_lens ON pms_health_checks (yacht_id, lens_id);
CREATE INDEX idx_health_checks_observed ON pms_health_checks (observed_at DESC);

-- RLS policies
ALTER TABLE pms_health_checks ENABLE ROW LEVEL SECURITY;

CREATE POLICY "yacht_scoped_health_checks"
    ON pms_health_checks
    FOR SELECT
    TO authenticated
    USING (yacht_id = get_user_yacht_id());

CREATE POLICY "service_role_write_health_checks"
    ON pms_health_checks
    FOR INSERT
    TO service_role
    WITH CHECK (true);

-- Health events (detailed logs)
CREATE TABLE IF NOT EXISTS pms_health_events (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
    check_id uuid NOT NULL,
    level text NOT NULL CHECK (level IN ('info', 'warning', 'error')),
    detail_json jsonb NOT NULL,
    created_at timestamp with time zone NOT NULL DEFAULT now(),
    CONSTRAINT fk_check FOREIGN KEY (check_id)
        REFERENCES pms_health_checks(id) ON DELETE CASCADE
);

CREATE INDEX idx_health_events_check ON pms_health_events (check_id);
CREATE INDEX idx_health_events_level ON pms_health_events (level, created_at DESC);

-- RLS policies
ALTER TABLE pms_health_events ENABLE ROW LEVEL SECURITY;

CREATE POLICY "yacht_scoped_health_events"
    ON pms_health_events
    FOR SELECT
    TO authenticated
    USING (
        check_id IN (
            SELECT id FROM pms_health_checks WHERE yacht_id = get_user_yacht_id()
        )
    );

CREATE POLICY "service_role_write_health_events"
    ON pms_health_events
    FOR INSERT
    TO service_role
    WITH CHECK (true);
```

---

## Acceptance Criteria

A lens is "template-compliant" when:

✅ **Render worker deployed**
- Writes health checks to `pms_health_checks` every N minutes
- Logs structured output (observable via Render dashboard)
- Detects flag toggles (503 → 200 transition)

✅ **CI workflows green**
- Staging acceptance: 5/5 tests passing (400/400/403/200 + audit JSON)
- Stress: 0×500 across 80+ requests, P50/P95/P99 captured
- Idempotency: Duplicate insert rejected (409), before/after counts prove single row

✅ **Evidence artifacts compiled**
- Raw HTTP transcripts (sanitized JWTs)
- Before/after DB queries
- Status code breakdown
- Percentile latencies
- Feature flag proof (OFF=503, ON=200)

✅ **Feature flags documented**
- All flags default OFF on main branch
- 503 FEATURE_DISABLED when flags OFF
- Toggle/rollback procedures documented
- Canary plan (4 phases: staging canary → staging full → prod canary → prod 100%)

✅ **Reusability proven**
- Generator script produces working files for "parts" lens (dry-run example)
- Manual copy method documented with step-by-step instructions

---

## Constraints to Respect (Canon)

1. **Backend authority:** UI never invents actions; suggestions returned by backend only
2. **RLS deny-by-default:** Helpers (`is_hod`, `is_fault_writer`, `is_related_editor`) strictly enforced
3. **Signature invariant:** `pms_audit_log.signature NOT NULL` (`{}` vs canonical JSON)
4. **Storage isolation:** Per-yacht prefixes; cross-yacht writes denied
5. **500 → fail:** Expected 4xx counted as PASS only when asserted explicitly with transcripts

---

## Next Steps

1. **Review this README** - Ensure approach aligns with operational needs
2. **Review template files** (next sections) - Verify structure and content
3. **Run generator for "parts" lens** (dry-run) - Sanity check
4. **Deploy worker for "faults" lens** - Production test
5. **Monitor for 7 days** - Verify automated checks catch issues
6. **Iterate** - Refine template based on lessons learned

---

## Support

**Questions?** See individual template files for detailed implementation notes.

**Issues?** Check `verification_handoff/phase6/ALL_SCRIPTS_REFERENCE.md` for troubleshooting.

**Changes?** Submit PR with updated templates; notify Ops team for Render config changes.
