# Local test environment for Inventory RLS validation
# Usage: docker compose -f docker-compose.test.yml up --build

services:
  api:
    build:
      context: ./apps/api
      dockerfile: Dockerfile
    ports:
      - "8890:8000"
    environment:
      # MASTER Supabase (auth/user lookup)
      - MASTER_SUPABASE_URL=${MASTER_SUPABASE_URL}
      - MASTER_SUPABASE_SERVICE_KEY=${MASTER_SUPABASE_SERVICE_KEY}
      - MASTER_SUPABASE_JWT_SECRET=${MASTER_SUPABASE_JWT_SECRET}
      # TENANT Supabase (yacht data)
      - ${DEFAULT_YACHT_CODE}_SUPABASE_URL=${TENANT_SUPABASE_URL}
      - ${DEFAULT_YACHT_CODE}_SUPABASE_SERVICE_KEY=${TENANT_SUPABASE_SERVICE_KEY}
      - DEFAULT_YACHT_CODE=${DEFAULT_YACHT_CODE}
      # Feature flags
      - FEATURE_PARTS=true
      # Port (Dockerfile uses $PORT)
      - PORT=8000
      - LOG_LEVEL=INFO
      - PYTHONUNBUFFERED=1
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/health')"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s

  test-runner:
    build:
      context: ./tests/docker
      dockerfile: Dockerfile.test
    depends_on:
      api:
        condition: service_healthy
    environment:
      - API_BASE=http://api:8000
      - MASTER_SUPABASE_URL=${MASTER_SUPABASE_URL}
      - MASTER_SUPABASE_ANON_KEY=${MASTER_SUPABASE_ANON_KEY}
      - TENANT_SUPABASE_URL=${TENANT_SUPABASE_URL}
      - TENANT_SUPABASE_SERVICE_KEY=${TENANT_SUPABASE_SERVICE_KEY}
      - YACHT_ID=${YACHT_ID}
      - CREW_EMAIL=${CREW_EMAIL}
      - HOD_EMAIL=${HOD_EMAIL}
      - TEST_PASSWORD=${TEST_PASSWORD}
    volumes:
      - ./docs/pipeline/inventory_lens/run_inventory_rls_tests.py:/tests/run_rls_tests.py:ro
