============================= test session starts ==============================
platform darwin -- Python 3.9.6, pytest-7.4.3, pluggy-1.6.0 -- /Library/Developer/CommandLineTools/usr/bin/python3
cachedir: .pytest_cache
rootdir: /Volumes/Backup/CELESTE/BACK_BUTTON_CLOUD_PMS/tests/inventory_lens
configfile: pytest.ini
plugins: mock-3.15.1, Faker-20.1.0, cov-4.1.0, asyncio-0.21.1, anyio-3.7.1, langsmith-0.4.8
asyncio: mode=auto
collecting ... collected 24 items / 6 deselected / 18 selected

tests/test_inventory_critical.py::TestConcurrency::test_concurrent_consume_atomic PASSED [  5%]
tests/test_inventory_critical.py::TestConcurrency::test_concurrent_receive_atomic PASSED [ 11%]
tests/test_inventory_critical.py::TestIdempotency::test_duplicate_receive_blocked PASSED [ 16%]
tests/test_inventory_critical.py::TestSoftDelete::test_consume_blocked_on_deactivated PASSED [ 22%]
tests/test_inventory_critical.py::TestSoftDelete::test_trigger_blocks_transaction_insert PASSED [ 27%]
tests/test_inventory_critical.py::TestSoftDelete::test_reactivate_restores_mutations PASSED [ 33%]
tests/test_inventory_critical.py::TestReversalUniqueness::test_double_reversal_blocked PASSED [ 38%]
tests/test_inventory_critical.py::TestReversalUniqueness::test_reversal_of_reversal_blocked PASSED [ 44%]
tests/test_inventory_critical.py::TestTransactionTypeRLS::test_crew_can_insert_consumed PASSED [ 50%]
tests/test_inventory_critical.py::TestTransactionTypeRLS::test_crew_cannot_insert_write_off FAILED [ 55%]
tests/test_inventory_critical.py::TestTransactionTypeRLS::test_crew_cannot_insert_reversed FAILED [ 61%]
tests/test_inventory_critical.py::TestTransferValidation::test_transfer_same_location_blocked FAILED [ 66%]
tests/test_inventory_critical.py::TestHelperParity::test_is_operational_crew_with_existing_users PASSED [ 72%]
tests/test_inventory_critical.py::TestHelperParity::test_is_hod_helper_function PASSED [ 77%]
tests/test_inventory_critical.py::TestDualLedgerConsistency::test_no_inventory_drift PASSED [ 83%]
tests/test_inventory_critical.py::TestStorageNegativeControls::test_documents_wrong_prefix_denied PASSED [ 88%]
tests/test_inventory_critical.py::TestStorageNegativeControls::test_labels_wrong_prefix_denied PASSED [ 94%]
tests/test_inventory_critical.py::TestStorageNegativeControls::test_storage_policies_require_operational_crew FAILED [100%]

=================================== FAILURES ===================================
___________ TestTransactionTypeRLS.test_crew_cannot_insert_write_off ___________
tests/test_inventory_critical.py:444: in test_crew_cannot_insert_write_off
    await db.execute("""
E   Failed: DID NOT RAISE <class 'Exception'>
___________ TestTransactionTypeRLS.test_crew_cannot_insert_reversed ____________
tests/test_inventory_critical.py:459: in test_crew_cannot_insert_reversed
    await db.execute("""
E   Failed: DID NOT RAISE <class 'Exception'>
__________ TestTransferValidation.test_transfer_same_location_blocked __________
tests/test_inventory_critical.py:479: in test_transfer_same_location_blocked
    location = await create_test_location(db, yacht_a, "Engine Room")
tests/helpers.py:76: in create_test_location
    await db.execute("""
/Users/celeste7/Library/Python/3.9/lib/python/site-packages/asyncpg/connection.py:353: in execute
    _, status, _ = await self._execute(
/Users/celeste7/Library/Python/3.9/lib/python/site-packages/asyncpg/connection.py:1794: in _execute
    result, _ = await self.__execute(
/Users/celeste7/Library/Python/3.9/lib/python/site-packages/asyncpg/connection.py:1892: in __execute
    result, stmt = await self._do_execute(
/Users/celeste7/Library/Python/3.9/lib/python/site-packages/asyncpg/connection.py:1945: in _do_execute
    result = await executor(stmt, None)
asyncpg/protocol/protocol.pyx:207: in bind_execute
    ???
E   asyncpg.exceptions.UniqueViolationError: duplicate key value violates unique constraint "uq_part_locations_yacht_name"
E   DETAIL:  Key (yacht_id, name)=(85fe1119-b04c-41ac-80f1-829d23322598, Engine Room) already exists.
__ TestStorageNegativeControls.test_storage_policies_require_operational_crew __
tests/test_inventory_critical.py:635: in test_storage_policies_require_operational_crew
    policies = await db.fetch("""
/Users/celeste7/Library/Python/3.9/lib/python/site-packages/asyncpg/connection.py:691: in fetch
    return await self._execute(
/Users/celeste7/Library/Python/3.9/lib/python/site-packages/asyncpg/connection.py:1794: in _execute
    result, _ = await self.__execute(
/Users/celeste7/Library/Python/3.9/lib/python/site-packages/asyncpg/connection.py:1892: in __execute
    result, stmt = await self._do_execute(
/Users/celeste7/Library/Python/3.9/lib/python/site-packages/asyncpg/connection.py:1925: in _do_execute
    stmt = await self._get_statement(
/Users/celeste7/Library/Python/3.9/lib/python/site-packages/asyncpg/connection.py:433: in _get_statement
    statement = await self._protocol.prepare(
asyncpg/protocol/protocol.pyx:166: in prepare
    ???
E   asyncpg.exceptions.UndefinedColumnError: column "policyname" does not exist
E   HINT:  Perhaps you meant to reference the column "p.polname".
- generated xml file: /Volumes/Backup/CELESTE/BACK_BUTTON_CLOUD_PMS/docs/evidence/inventory_item/junit_test_run_20260127_192726.xml -
=========================== short test summary info ============================
FAILED tests/test_inventory_critical.py::TestTransactionTypeRLS::test_crew_cannot_insert_write_off
FAILED tests/test_inventory_critical.py::TestTransactionTypeRLS::test_crew_cannot_insert_reversed
FAILED tests/test_inventory_critical.py::TestTransferValidation::test_transfer_same_location_blocked
FAILED tests/test_inventory_critical.py::TestStorageNegativeControls::test_storage_policies_require_operational_crew
=========== 4 failed, 14 passed, 6 deselected, 3 warnings in 15.21s ============
