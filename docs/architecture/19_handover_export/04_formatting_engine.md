# Formatting Engine

## HTML/PDF Generation for Handover Export

This document defines how signed handovers are rendered into professional documents.

---

## Core Principle

**Export is representation, not transformation.**

The formatting engine:
- Preserves all content exactly
- Adds visual structure and styling
- Embeds hyperlinks to sources
- Never alters meaning

---

## Output Formats

### HTML

**Primary use:** Interactive viewing, email body

**Features:**
- Responsive layout
- Clickable hyperlinks
- Print-optimized CSS
- Self-contained (no external dependencies)

### PDF

**Primary use:** Archival, formal distribution, audit

**Features:**
- Fixed layout for printing
- Page numbers and headers
- Embedded fonts
- Digital signature placeholder

### Email

**Primary use:** Distribution to recipients

**Features:**
- HTML body with summary
- PDF attachment
- Plain-text fallback

---

## Document Structure

Every exported handover follows this fixed structure:

```
┌──────────────────────────────────────────┐
│              HEADER                       │
│  • Vessel name                           │
│  • Reporting period                      │
│  • Shift type (Day/Night/Weekly)         │
│  • Generated timestamp                   │
└──────────────────────────────────────────┘

┌──────────────────────────────────────────┐
│           SIGNATORY BLOCK                │
│  • Outgoing: Name, Role, Time            │
│  • Incoming: Name, Role, Time            │
│  • Document hash (for verification)      │
└──────────────────────────────────────────┘

┌──────────────────────────────────────────┐
│         EXECUTIVE SUMMARY                │
│  • Total items: 13                       │
│  • Critical items: 2                     │
│  • Sections: 4                           │
│  • Unacknowledged: 3                     │
└──────────────────────────────────────────┘

┌──────────────────────────────────────────┐
│            SECTION 1                      │
│  Engineering (4 items)                   │
├──────────────────────────────────────────┤
│  [CRITICAL] Generator 2 cooling issue   │
│  • Summary text...                       │
│  • Source: F-2024-0031                   │
│  • Added by: John Smith                  │
│                                          │
│  [HIGH] Work order in progress           │
│  • Summary text...                       │
│  • Source: WO-2024-0142                  │
└──────────────────────────────────────────┘

┌──────────────────────────────────────────┐
│            SECTION 2                      │
│  Deck (3 items)                          │
├──────────────────────────────────────────┤
│  ...                                     │
└──────────────────────────────────────────┘

... (repeat for all sections)

┌──────────────────────────────────────────┐
│              FOOTER                       │
│  • Page X of Y                           │
│  • Document hash                         │
│  • "Generated by CelesteOS"              │
└──────────────────────────────────────────┘
```

---

## Section Ordering

Sections always appear in this fixed order (if they have content):

1. **Command** - Operational synthesis
2. **Engineering** - Mechanical systems
3. **ETO / AV-IT** - Electronics and networks
4. **Deck** - Exterior operations
5. **Interior** - Guest-facing hotel
6. **Galley** - Food service
7. **Security** - Access and safety
8. **Admin & Compliance** - Administrative

Empty sections are hidden, not shown as blank.

---

## Item Formatting

### Priority Badges

```html
<span class="priority-badge critical">CRITICAL</span>
<span class="priority-badge high">HIGH</span>
<span class="priority-badge normal">NORMAL</span>
<span class="priority-badge low">LOW</span>
```

**Styling:**
- CRITICAL: Red background (#dc3545), white text
- HIGH: Orange background (#fd7e14), white text
- NORMAL: Blue background (#0d6efd), white text
- LOW: Gray background (#6c757d), white text

### Status Badges

```html
<span class="status-badge pending">Pending</span>
<span class="status-badge acknowledged">Acknowledged</span>
<span class="status-badge completed">Completed</span>
<span class="status-badge deferred">Deferred</span>
```

### Entity Type Tags

```html
<span class="entity-type">FAULT</span>
<span class="entity-type">WORK ORDER</span>
<span class="entity-type">EQUIPMENT</span>
<span class="entity-type">DOCUMENT</span>
<span class="entity-type">EMAIL</span>
```

---

## Typography

**Font family:** System fonts (no external dependencies)

```css
font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto,
             'Helvetica Neue', Arial, sans-serif;
```

**Sizes:**
- Document title: 28px
- Section headers: 18px
- Item summaries: 14px
- Metadata: 12px

**Colors:**
- Primary text: #1a1a1a
- Secondary text: #6c757d
- Links: #0d6efd
- Critical accent: #dc3545
- Background: #f5f5f5 (gray) / #ffffff (white)

---

## CSS Template

```css
* { box-sizing: border-box; margin: 0; padding: 0; }

body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    max-width: 900px;
    margin: 0 auto;
    padding: 24px;
    background: #f5f5f5;
    color: #1a1a1a;
    line-height: 1.5;
}

.report-header {
    background: linear-gradient(135deg, #1e3a5f 0%, #2d5a87 100%);
    color: white;
    padding: 32px;
    border-radius: 12px;
    margin-bottom: 24px;
}

.signatory-block {
    background: #ffffff;
    border: 2px solid #1e3a5f;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 24px;
    display: flex;
    justify-content: space-between;
}

.signature {
    text-align: center;
    padding: 16px;
}

.signature-name {
    font-weight: 600;
    font-size: 16px;
}

.signature-role {
    color: #6c757d;
    font-size: 13px;
}

.signature-time {
    font-size: 12px;
    color: #6c757d;
    margin-top: 4px;
}

.section {
    background: white;
    border-radius: 12px;
    margin-bottom: 20px;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
}

.section-header {
    background: #f8f9fa;
    padding: 16px 20px;
    border-bottom: 1px solid #e9ecef;
    display: flex;
    align-items: center;
    gap: 12px;
}

.handover-item {
    padding: 16px;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    margin: 12px;
    border-left: 4px solid #6c757d;
}

.handover-item.critical {
    border-left-color: #dc3545;
    background: #fff5f5;
}

.handover-item.high {
    border-left-color: #fd7e14;
    background: #fff8f0;
}

.entity-link {
    color: #0d6efd;
    text-decoration: none;
    font-weight: 500;
}

.entity-link:hover {
    text-decoration: underline;
}

@media print {
    body { background: white; padding: 0; }
    .section { box-shadow: none; border: 1px solid #ddd; }
    .report-header { -webkit-print-color-adjust: exact; }
}
```

---

## PDF Generation

**Engine:** WeasyPrint (Python)

```python
from weasyprint import HTML, CSS

def generate_pdf(html_content: str, output_path: str) -> str:
    """Generate PDF from HTML content."""
    html = HTML(string=html_content)

    # Custom CSS for print optimization
    css = CSS(string='''
        @page {
            size: A4;
            margin: 2cm;
            @bottom-center {
                content: "Page " counter(page) " of " counter(pages);
                font-size: 10px;
                color: #6c757d;
            }
        }
        @page :first {
            margin-top: 1cm;
        }
    ''')

    html.write_pdf(output_path, stylesheets=[css])
    return output_path
```

---

## Rendering Pipeline

```python
async def render_export(draft: HandoverDraft, format: str) -> str:
    """
    Render draft to export format.

    1. Fetch all draft data (sections, items, edits, signoffs)
    2. Enrich items with entity details
    3. Generate HTML from template
    4. If PDF: convert HTML → PDF
    5. Store in Supabase Storage
    6. Return storage path
    """

    # 1. Fetch data
    sections = await fetch_draft_sections(draft.id)
    items = await fetch_draft_items(draft.id)
    signoffs = await fetch_signoffs(draft.id)

    # 2. Enrich with entity details
    enriched_items = await enrich_with_entities(items)

    # 3. Generate HTML
    html = render_html_template(
        draft=draft,
        sections=sections,
        items=enriched_items,
        signoffs=signoffs
    )

    # 4. Convert to PDF if needed
    if format == "pdf":
        output_path = f"/tmp/{draft.id}.pdf"
        generate_pdf(html, output_path)
        content = open(output_path, 'rb').read()
        content_type = "application/pdf"
        file_ext = "pdf"
    else:
        content = html.encode('utf-8')
        content_type = "text/html"
        file_ext = "html"

    # 5. Store in Supabase
    storage_path = f"{draft.yacht_id}/handover/{draft.id}/{timestamp()}.{file_ext}"
    await upload_to_storage(storage_path, content, content_type)

    return storage_path
```

---

## Template Variables

| Variable | Source | Description |
|----------|--------|-------------|
| `{{vessel_name}}` | yacht_registry | Vessel display name |
| `{{period_start}}` | draft | Start of reporting period |
| `{{period_end}}` | draft | End of reporting period |
| `{{shift_type}}` | draft | Day/Night/Weekly |
| `{{outgoing_name}}` | signoffs | Outgoing officer name |
| `{{outgoing_role}}` | signoffs | Outgoing officer role |
| `{{outgoing_time}}` | signoffs | Acceptance timestamp |
| `{{incoming_name}}` | signoffs | Incoming officer name |
| `{{incoming_role}}` | signoffs | Incoming officer role |
| `{{incoming_time}}` | signoffs | Countersign timestamp |
| `{{document_hash}}` | signoffs | SHA-256 hash (truncated) |
| `{{total_items}}` | computed | Total item count |
| `{{critical_count}}` | computed | Critical item count |
| `{{sections}}` | draft_sections | Array of section objects |

---

## Non-Negotiable

- No export before sign-off
- No template deviation between exports
- No removal of source references
- No omission of signatory block
- Document hash must be visible and verifiable

---
