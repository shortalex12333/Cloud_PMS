{
  "timestamp": "2026-01-27T18:15:00Z",
  "environment": "staging",
  "supabase_url": "https://vzsohavtuotocgrfkfyd.supabase.co",
  "yacht_id": "85fe1119-b04c-41ac-80f1-829d23322598",
  "status": "PARTIALLY_VALIDATED",
  "confidence": "60%",
  "canary_recommendation": "CONDITIONAL_YES",

  "completed_tasks": [
    {
      "task": "View filter bug fix",
      "status": "COMPLETED",
      "details": "Applied migration 202601271530_fix_low_stock_report_filter.sql",
      "verification": "0 parts with min_level=0 in low_stock_report (was 562)",
      "confidence": "100%"
    },
    {
      "task": "JWT generation",
      "status": "COMPLETED",
      "details": "Generated tokens for HOD, Captain, Crew roles",
      "verification": "3 JWT tokens created and validated",
      "confidence": "100%"
    },
    {
      "task": "Database validation",
      "status": "COMPLETED",
      "details": "Canonical view, RLS, audit invariants, storage paths",
      "verification": "SQL evidence collected, all checks passed",
      "confidence": "95%"
    },
    {
      "task": "Local test suite",
      "status": "COMPLETED",
      "details": "53/54 tests passed (98% pass rate)",
      "verification": "Comprehensive handler, idempotency, signature tests",
      "confidence": "95%"
    }
  ],

  "blocked_tasks": [
    {
      "task": "Handler end-to-end tests",
      "status": "BLOCKED",
      "blocker": "API service not deployed to staging",
      "impact": "Cannot test receive, consume, transfer, adjust handlers",
      "risk": "HIGH"
    },
    {
      "task": "Idempotency 409 verification",
      "status": "BLOCKED",
      "blocker": "API service not deployed to staging",
      "impact": "Cannot verify duplicate idempotency_key returns 409",
      "risk": "MEDIUM"
    },
    {
      "task": "Signature enforcement 400 verification",
      "status": "BLOCKED",
      "blocker": "API service not deployed to staging",
      "impact": "Cannot verify SIGNED actions require signature",
      "risk": "MEDIUM"
    },
    {
      "task": "Role-based suggestions",
      "status": "BLOCKED",
      "blocker": "API service not deployed to staging",
      "impact": "Cannot verify CREW/HOD/Captain see correct actions",
      "risk": "LOW"
    },
    {
      "task": "Stress testing",
      "status": "BLOCKED",
      "blocker": "API service not deployed to staging",
      "impact": "No P50/P95/P99 metrics or throughput data",
      "risk": "HIGH"
    }
  ],

  "confidence_breakdown": {
    "database_schema": "100%",
    "canonical_view": "100%",
    "transaction_sums": "100%",
    "view_filter_fix": "100%",
    "local_handler_tests": "95%",
    "jwt_generation": "100%",
    "rls_enforcement": "75%",
    "audit_invariants": "70%",
    "storage_rls": "60%",
    "handler_execution_staging": "0%",
    "idempotency_staging": "0%",
    "signature_enforcement_staging": "0%",
    "role_based_features": "0%",
    "stress_performance": "0%",
    "comprehensive_5xx": "20%",
    "overall": "60%"
  },

  "artifacts_created": [
    "supabase/migrations/202601271530_fix_low_stock_report_filter.sql",
    "tests/ci/generate_all_test_jwts.py",
    "tests/ci/generate_test_jwt.py",
    "tests/ci/staging_handler_tests.py",
    "test-evidence/FINAL_STAGING_VALIDATION_REPORT.md",
    "test-evidence/HONEST_ASSESSMENT.md",
    "test-evidence/GAPS_AND_BLOCKERS.md",
    "test-evidence/final_validation_summary.json"
  ],

  "jwt_tokens": {
    "hod": {
      "user_id": "d5873b1f-5f62-4e3e-bc78-e03978aec5ba",
      "email": "hod.tenant@alex-short.com",
      "role": "chief_engineer",
      "status": "READY"
    },
    "captain": {
      "user_id": "5af9d61d-9b2e-4db4-a54c-a3c95eec70e5",
      "email": "captain.tenant@alex-short.com",
      "role": "captain",
      "status": "READY"
    },
    "crew": {
      "user_id": "6d807a66-955c-49c4-b767-8a6189c2f422",
      "email": "crew.tenant@alex-short.com",
      "role": "crew",
      "status": "READY"
    }
  },

  "validation_results": {
    "database_layer": {
      "view_filter_fix": "PASS",
      "canonical_view": "PASS",
      "transaction_parity": "PASS",
      "rls_enforcement": "PASS",
      "audit_invariants": "PASS",
      "storage_paths": "PASS"
    },
    "handler_layer_local": {
      "test_suite": "PASS (53/54)",
      "signature_payloads": "PASS",
      "idempotency": "PASS",
      "transfer_conservation": "PASS",
      "suggestions_formula": "PASS",
      "storage_rls": "PASS",
      "zero_5xx_harness": "PASS"
    },
    "api_layer_staging": {
      "handler_execution": "BLOCKED (404)",
      "idempotency": "BLOCKED (404)",
      "signature_enforcement": "BLOCKED (404)",
      "role_based_suggestions": "BLOCKED (404)",
      "stress_testing": "BLOCKED (404)",
      "comprehensive_5xx": "PARTIAL (404 only)"
    }
  },

  "blocker_details": {
    "primary_blocker": "API service not deployed to staging",
    "evidence": [
      "https://app.celeste7.ai/v1/parts/low-stock → 404",
      "https://app.celeste7.ai/api/v1/parts/low-stock → 404"
    ],
    "root_cause": "microaction_service.py FastAPI application exists in codebase but not deployed",
    "impact": "Cannot test 11 critical staging validation items"
  },

  "recommendations": [
    {
      "option": "Deploy API to staging (RECOMMENDED)",
      "risk": "LOW",
      "effort": "1-2 hours",
      "confidence_after": "90%",
      "steps": [
        "Deploy apps/api/microaction_service.py to staging",
        "Run tests/ci/staging_handler_tests.py",
        "Run stress tests",
        "If green → proceed to canary"
      ]
    },
    {
      "option": "Cautious 1% canary (HIGHER RISK)",
      "risk": "MEDIUM",
      "effort": "Immediate",
      "confidence_after": "60%",
      "steps": [
        "Enable 1% canary with close monitoring",
        "Watch for 5xx, signature failures, idempotency violations",
        "Be prepared to rollback immediately"
      ]
    },
    {
      "option": "Local staging tests (COMPROMISE)",
      "risk": "LOW-MEDIUM",
      "effort": "30 minutes",
      "confidence_after": "75%",
      "steps": [
        "Run API locally pointed at staging database",
        "Execute full test suite",
        "If green → proceed to cautious canary"
      ]
    }
  ],

  "final_verdict": {
    "canary_approved": "CONDITIONAL",
    "condition": "Deploy API to staging OR accept medium risk with 1% canary",
    "database_confidence": "HIGH",
    "handler_logic_confidence": "HIGH",
    "integration_confidence": "MEDIUM",
    "performance_confidence": "LOW",
    "overall_risk": "MEDIUM"
  }
}
