services:
  # Pipeline V1 - Unified Search Service
  - type: web
    name: celeste-pipeline-v1
    runtime: python
    plan: starter
    region: oregon
    branch: main
    buildCommand: chmod +x build.sh && ./build.sh
    startCommand: cd apps/api && uvicorn pipeline_service:app --host 0.0.0.0 --port $PORT
    healthCheckPath: /health
    autoDeploy: true
    envVars:
      - key: PYTHON_VERSION
        value: "3.11.6"
      # MASTER DB - User auth & fleet registry
      - key: MASTER_SUPABASE_URL
        value: "https://qvzmkaamzaqxpzbewjxe.supabase.co"
      - key: MASTER_SUPABASE_SERVICE_KEY
        sync: false
      # TENANT_1 DB - PMS data for yTEST_YACHT_001
      - key: yTEST_YACHT_001_SUPABASE_URL
        value: "https://vzsohavtuotocgrfkfyd.supabase.co"
      - key: yTEST_YACHT_001_SUPABASE_SERVICE_KEY
        sync: false
      - key: yTEST_YACHT_001_SUPABASE_ANON_KEY
        sync: false
      # Default/fallback (points to TENANT_1)
      - key: SUPABASE_URL
        value: "https://vzsohavtuotocgrfkfyd.supabase.co"
      - key: SUPABASE_SERVICE_KEY
        sync: false
      - key: TENANT_SUPABASE_ANON_KEY
        sync: false
      - key: OPENAI_API_KEY
        sync: false
      # Feature Flags - Shopping List Lens v1 Canary
      - key: SHOPPING_LIST_LENS_V1_ENABLED
        value: "true"

  # Email Watcher Background Worker
  - type: worker
    name: celeste-email-watcher
    runtime: python
    plan: starter
    region: oregon
    branch: main
    buildCommand: cd apps/api && pip install -r requirements.txt
    startCommand: cd apps/api && python -m workers.email_watcher_worker
    autoDeploy: true
    envVars:
      - key: PYTHON_VERSION
        value: "3.11.6"
      - key: EMAIL_WATCHER_ENABLED
        value: "true"
      - key: EMAIL_WATCHER_POLL_INTERVAL
        value: "60"
      - key: EMAIL_WATCHER_BATCH_SIZE
        value: "10"
      - key: SUPABASE_URL
        value: "https://vzsohavtuotocgrfkfyd.supabase.co"
      - key: SUPABASE_SERVICE_KEY
        sync: false
      - key: MICROSOFT_CLIENT_ID_READ
        sync: false
      - key: MICROSOFT_CLIENT_SECRET_READ
        sync: false

  # Documents Health Worker - Lens Ops Monitoring
  - type: worker
    name: documents-health-worker
    runtime: python
    plan: starter
    region: oregon
    branch: main
    buildCommand: pip install requests PyJWT
    startCommand: python tools/ops/monitors/documents_health_worker.py
    autoDeploy: true
    envVars:
      - key: PYTHON_VERSION
        value: "3.11.6"
      - key: HEALTH_CHECK_INTERVAL_MINUTES
        value: "15"
      - key: API_BASE_URL
        value: "https://celeste-pipeline-v1.onrender.com"
      - key: TENANT_SUPABASE_URL
        value: "https://vzsohavtuotocgrfkfyd.supabase.co"
      - key: SUPABASE_SERVICE_KEY
        sync: false
      - key: TENANT_SUPABASE_JWT_SECRET
        sync: false
      - key: TEST_YACHT_ID
        value: "85fe1119-b04c-41ac-80f1-829d23322598"
      - key: TEST_HOD_USER_ID
        value: "05a488fd-e099-4d18-bf86-d87afba4fcdf"
      - key: TEST_HOD_EMAIL
        value: "hod.test@alex-short.com"
      - key: LOG_LEVEL
        value: "INFO"

  # Shopping List Health Worker - Lens Ops Monitoring
  - type: worker
    name: shopping-list-health-worker
    runtime: python
    plan: starter
    region: oregon
    branch: main
    buildCommand: pip install requests PyJWT
    startCommand: python tools/ops/monitors/shopping_list_health_worker.py
    autoDeploy: true
    envVars:
      - key: PYTHON_VERSION
        value: "3.11.6"
      - key: HEALTH_CHECK_INTERVAL_MINUTES
        value: "15"
      - key: API_BASE_URL
        value: "https://celeste-pipeline-v1.onrender.com"
      - key: TENANT_SUPABASE_URL
        value: "https://vzsohavtuotocgrfkfyd.supabase.co"
      - key: SUPABASE_SERVICE_KEY
        sync: false
      - key: TENANT_SUPABASE_JWT_SECRET
        sync: false
      - key: TEST_YACHT_ID
        value: "85fe1119-b04c-41ac-80f1-829d23322598"
      - key: TEST_HOD_USER_ID
        value: "05a488fd-e099-4d18-bf86-d87afba4fcdf"
      - key: TEST_HOD_EMAIL
        value: "hod.test@alex-short.com"
      - key: LOG_LEVEL
        value: "INFO"
