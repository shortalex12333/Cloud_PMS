{
  "blocker": "B003",
  "name": "Supabase Search RPC Signature Mismatch",
  "status": "RESOLVED",
  "resolved_at": "2026-01-20T14:20:00Z",
  "database": "vzsohavtuotocgrfkfyd (TENANT)",

  "root_cause": {
    "issue": "unified_search_v2 RPC requires embedding vector that code doesn't provide",
    "actual_signature": "unified_search_v2(query_text, query_embedding vector, p_yacht_id, intent, match_count)",
    "code_expected": "search_query, p_yacht_id, result_limit (no embedding)"
  },

  "fix_applied": {
    "action": "Created unified_search_simple RPC",
    "rpc_name": "unified_search_simple",
    "signature": "unified_search_simple(search_query text, p_yacht_id uuid, result_limit integer DEFAULT 20)",
    "returns": "TABLE(result_id, result_type, result_label, secondary_label, similarity_score, metadata)",
    "search_targets": ["pms_parts", "pms_equipment", "pms_work_orders", "doc_metadata", "pms_faults"],
    "matching": "Trigram similarity + ILIKE fallback"
  },

  "code_updates": {
    "table_capabilities.py": "Updated comment to reference unified_search_simple",
    "capability_executor.py": "Updated RPC param comment"
  },

  "verification": {
    "test_1": {
      "query": "fuel filter",
      "result_count": 5,
      "top_result": {"type": "part", "label": "Test Fuel Filter", "score": 0.6875}
    },
    "test_2": {
      "query": "watermaker",
      "result_count": 3,
      "top_result": {"type": "equipment", "label": "Watermaker", "score": 1.0}
    },
    "verdict": "PASSED - RPC returns relevant results"
  },

  "notes": {
    "primary_search": "Goes through Render pipeline (handles embeddings server-side)",
    "fallback_search": "unified_search_simple provides text-only search capability",
    "unified_search_v2": "Still exists for embedding-based search when embeddings are available"
  },

  "conclusion": "B003 RESOLVED - Created unified_search_simple RPC matching code parameter expectations"
}
