{
  "blocker": "B005",
  "name": "add_to_handover ActionExecutionError",
  "status": "RESOLVED",
  "resolved_at": "2026-01-20T14:57:00Z",
  "database": "vzsohavtuotocgrfkfyd (TENANT)",

  "root_causes_found": [
    {
      "issue": "entity_type check constraint mismatch",
      "details": "Handler allowed 'document_chunk', 'part' but DB only allowed 'work_order', 'fault', 'equipment', 'note'",
      "fix": "Updated check constraint to include all handler entity types"
    },
    {
      "issue": "RLS policy used wrong pattern",
      "details": "Used current_setting('app.current_yacht_id') which is not set by API",
      "fix": "Changed to get_user_yacht_id() pattern matching other tables"
    }
  ],

  "fixes_applied": {
    "constraint_update": "ALTER TABLE pms_handover DROP/ADD CONSTRAINT pms_handover_entity_type_check to include: work_order, fault, equipment, note, document_chunk, part",
    "rls_policies": [
      "Users can view handover - SELECT using get_user_yacht_id()",
      "Users can create handover - INSERT using get_user_yacht_id()",
      "Users can update handover - UPDATE using get_user_yacht_id()",
      "Users can delete handover - DELETE using get_user_yacht_id() AND is_manager()",
      "Service role full access handover - ALL to service_role"
    ]
  },

  "verification": {
    "api_test": {
      "endpoint": "POST /v1/actions/execute",
      "action": "add_to_handover",
      "payload": {
        "title": "Equipment Status Check",
        "entity_type": "equipment",
        "entity_id": "e1000001-0001-4001-8001-000000000001",
        "summary_text": "Testing add_to_handover",
        "category": "watch"
      },
      "response": {
        "status": "success",
        "handover_id": "837e4af5-2359-4746-a474-76573e151118"
      }
    },
    "database_verification": {
      "entry_created": true,
      "entity_type": "equipment",
      "category": "watch"
    },
    "verdict": "PASSED"
  },

  "conclusion": "B005 RESOLVED - Fixed DB constraint and RLS policy. add_to_handover action now executes successfully."
}
