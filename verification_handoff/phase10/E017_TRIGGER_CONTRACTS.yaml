# E017: TRIGGER CONTRACTS
# Date: 2026-01-21
# Phase: 10 - Decision Policy Layer
# Status: LOCKED
#
# Rules:
# - No action without a trigger
# - "Show always" is FORBIDDEN
# - If intent is missing â†’ suppress
# - Every action must be explainable

version: "1.0.0"
locked_at: "2026-01-21T12:00:00Z"

# =============================================================================
# NOTES ACTIONS (1)
# =============================================================================

add_note_to_work_order:
  tier: primary
  requires:
    intent:
      - document
      - add_note
      - log_activity
      - update_progress
    entities:
      min:
        - work_order
    situation:
      - work_order_active  # status in [open, in_progress]
  forbidden:
    - work_order_cancelled
    - work_order_closed
    - no_work_order
  default_visibility: conditional
  explanation_template: "Add note to active work order {work_order.title}"

# =============================================================================
# WORK ORDER ACTIONS (14)
# =============================================================================

create_work_order:
  tier: conditional
  requires:
    intent:
      - create_work
      - schedule_maintenance
      - plan_repair
      - fix_equipment
    entities:
      min:
        - equipment
    situation:
      - equipment_identified
  forbidden:
    - duplicate_wo_for_fault  # If creating from fault context
    - no_equipment
  default_visibility: conditional
  explanation_template: "Create work order for {equipment.name}"

close_work_order:
  tier: conditional
  requires:
    intent:
      - complete_work
      - close
      - finish
      - done
    entities:
      min:
        - work_order
    situation:
      - work_order_in_progress  # status = in_progress
  forbidden:
    - work_order_open  # Must start first
    - work_order_closed
    - work_order_cancelled
  default_visibility: conditional
  explanation_template: "Close work order {work_order.title} (currently in progress)"

add_work_order_photo:
  tier: conditional
  requires:
    intent:
      - add_photo
      - capture_evidence
      - document_visually
    entities:
      min:
        - work_order
    situation:
      - work_order_active
  forbidden:
    - work_order_closed
    - work_order_cancelled
  default_visibility: hidden
  explanation_template: "Add photo to document work on {work_order.title}"

add_parts_to_work_order:
  tier: rare
  requires:
    intent:
      - add_parts
      - log_materials
      - use_inventory
    entities:
      min:
        - work_order
        - part  # Must have part context
    situation:
      - work_order_active
      - part_available
  forbidden:
    - work_order_closed
    - no_part_context
  default_visibility: hidden
  explanation_template: "Add {part.name} to work order {work_order.title}"

view_work_order_checklist:
  tier: primary
  requires:
    intent:
      - view_checklist
      - see_steps
      - review_procedure
    entities:
      min:
        - work_order
    situation:
      - work_order_has_checklist
  forbidden:
    - no_checklist_attached
  default_visibility: conditional
  explanation_template: "View checklist for {work_order.title}"

assign_work_order:
  tier: rare
  requires:
    intent:
      - assign
      - delegate
      - reassign
    entities:
      min:
        - work_order
    situation:
      - user_is_hod
      - work_order_active
  forbidden:
    - user_not_hod
    - work_order_closed
    - work_order_cancelled
  default_visibility: hidden
  explanation_template: "Assign {work_order.title} to team member (HOD only)"

update_work_order:
  tier: conditional
  requires:
    intent:
      - update
      - modify
      - change_priority
      - edit
    entities:
      min:
        - work_order
    situation:
      - work_order_active
  forbidden:
    - work_order_closed
    - work_order_cancelled
  default_visibility: conditional
  explanation_template: "Update details for {work_order.title}"

add_wo_hours:
  tier: conditional
  requires:
    intent:
      - log_time
      - add_hours
      - track_labor
    entities:
      min:
        - work_order
    situation:
      - work_order_active
  forbidden:
    - work_order_closed
    - work_order_cancelled
  default_visibility: hidden
  explanation_template: "Log labor hours for {work_order.title}"

add_wo_part:
  tier: rare
  requires:
    intent:
      - add_part
      - use_part
      - log_material
    entities:
      min:
        - work_order
    situation:
      - work_order_active
  forbidden:
    - work_order_closed
  default_visibility: hidden
  explanation_template: "Add part to {work_order.title}"

add_wo_note:
  tier: primary
  requires:
    intent:
      - add_note
      - document
      - comment
      - update
    entities:
      min:
        - work_order
    situation:
      - work_order_active
  forbidden:
    - work_order_cancelled
  default_visibility: conditional
  explanation_template: "Add note to {work_order.title}"

start_work_order:
  tier: conditional
  requires:
    intent:
      - start
      - begin
      - commence
    entities:
      min:
        - work_order
    situation:
      - work_order_open  # status = open
  forbidden:
    - work_order_in_progress
    - work_order_closed
    - work_order_cancelled
  default_visibility: conditional
  explanation_template: "Start work on {work_order.title}"

cancel_work_order:
  tier: rare
  requires:
    intent:
      - cancel
      - abort
      - delete_work
    entities:
      min:
        - work_order
    situation:
      - user_is_hod
      - work_order_active
  forbidden:
    - user_not_hod
    - work_order_closed
    - work_order_completed
  default_visibility: hidden
  confirmation_required: true
  explanation_template: "Cancel {work_order.title} (HOD only, irreversible)"

view_work_order_detail:
  tier: primary
  requires:
    intent:
      - view
      - details
      - show
      - info
    entities:
      min:
        - work_order
    situation: []  # Always valid if entity exists
  forbidden:
    - no_work_order
  default_visibility: conditional
  explanation_template: "View details for {work_order.title}"

create_work_order_from_fault:
  tier: conditional
  requires:
    intent:
      - create_work
      - schedule_repair
      - escalate
      - fix
    entities:
      min:
        - fault
    situation:
      - fault_has_no_work_order
  forbidden:
    - fault_has_work_order
    - fault_closed
  default_visibility: conditional
  explanation_template: "Create work order to resolve fault {fault.title}"

# =============================================================================
# EQUIPMENT ACTIONS (1)
# =============================================================================

update_equipment_status:
  tier: conditional
  requires:
    intent:
      - update_status
      - change_status
      - mark_operational
      - mark_offline
    entities:
      min:
        - equipment
    situation:
      - equipment_identified
  forbidden:
    - no_equipment
  default_visibility: conditional
  explanation_template: "Update status for {equipment.name}"

# =============================================================================
# HANDOVER ACTIONS (1)
# =============================================================================

add_to_handover:
  tier: primary
  requires:
    intent:
      - handover
      - transfer
      - end_shift
      - brief
      - communicate
    entities:
      min_one_of:
        - work_order
        - equipment
        - fault
    situation:
      - active_work_context
  forbidden:
    - no_entity_context
    - all_work_closed
  default_visibility: conditional
  explanation_template: "Add to handover briefing: {entity.summary}"

# =============================================================================
# FAULT ACTIONS (10)
# =============================================================================

report_fault:
  tier: primary
  requires:
    intent:
      - report_fault
      - log_problem
      - something_wrong
      - broken
      - issue
    entities:
      min:
        - equipment
    situation:
      - equipment_identified
  forbidden:
    - no_equipment
    - duplicate_active_fault  # Same symptom already reported
  default_visibility: conditional
  explanation_template: "Report fault on {equipment.name}"

acknowledge_fault:
  tier: conditional
  requires:
    intent:
      - acknowledge
      - accept
      - take_ownership
      - I_see_it
    entities:
      min:
        - fault
    situation:
      - fault_not_acknowledged
  forbidden:
    - fault_already_acknowledged
    - fault_closed
  default_visibility: conditional
  explanation_template: "Acknowledge fault {fault.title}"

close_fault:
  tier: conditional
  requires:
    intent:
      - close
      - resolve
      - fixed
      - complete
    entities:
      min:
        - fault
    situation:
      - fault_open
      - fault_has_no_active_wo  # Work order must be closed first
  forbidden:
    - fault_closed
    - fault_has_active_work_order
  default_visibility: conditional
  explanation_template: "Close fault {fault.title} (work complete)"

update_fault:
  tier: conditional
  requires:
    intent:
      - update
      - modify
      - add_info
      - change
    entities:
      min:
        - fault
    situation:
      - fault_open
  forbidden:
    - fault_closed
  default_visibility: conditional
  explanation_template: "Update fault {fault.title}"

add_fault_photo:
  tier: conditional
  requires:
    intent:
      - add_photo
      - capture
      - document
      - evidence
    entities:
      min:
        - fault
    situation:
      - fault_open
  forbidden:
    - fault_closed
  default_visibility: hidden
  explanation_template: "Add photo to document fault {fault.title}"

view_fault_detail:
  tier: primary
  requires:
    intent:
      - view
      - details
      - show
      - info
    entities:
      min:
        - fault
    situation: []  # Always valid if entity exists
  forbidden:
    - no_fault
  default_visibility: conditional
  explanation_template: "View details for fault {fault.title}"

diagnose_fault:
  tier: primary
  requires:
    intent:
      - diagnose
      - analyze
      - what_is_wrong
      - troubleshoot
    entities:
      min:
        - fault
    situation:
      - fault_exists
  forbidden:
    - no_fault
  default_visibility: conditional
  auto_run_on_card_mount: true
  explanation_template: "AI diagnosis for fault {fault.title}"

reopen_fault:
  tier: conditional
  requires:
    intent:
      - reopen
      - recurred
      - not_fixed
      - came_back
    entities:
      min:
        - fault
    situation:
      - fault_closed
  forbidden:
    - fault_open
    - fault_in_progress
  default_visibility: hidden
  explanation_template: "Reopen fault {fault.title} (issue recurred)"

mark_fault_false_alarm:
  tier: rare
  requires:
    intent:
      - false_alarm
      - mistake
      - not_real
      - dismiss
    entities:
      min:
        - fault
    situation:
      - fault_open
  forbidden:
    - fault_closed
    - fault_has_work_order  # Can't dismiss if work scheduled
  default_visibility: hidden
  confirmation_required: true
  explanation_template: "Mark fault {fault.title} as false alarm (will close)"

show_manual_section:
  tier: primary
  requires:
    intent:
      - manual
      - documentation
      - how_to
      - procedure
      - instructions
    entities:
      min:
        - equipment
    situation:
      - equipment_has_manual
  forbidden:
    - no_manual_available
    - no_equipment
  default_visibility: conditional
  explanation_template: "View manual for {equipment.name}"

# =============================================================================
# WORKLIST ACTIONS (3)
# =============================================================================

view_worklist:
  tier: primary
  requires:
    intent:
      - view_worklist
      - tasks
      - todo
      - what_to_do
    entities:
      optional:
        - work_order
    situation:
      - in_shipyard_or_has_worklist
  forbidden:
    - no_worklist_context
  default_visibility: conditional
  explanation_template: "View worklist tasks"

add_worklist_task:
  tier: conditional
  requires:
    intent:
      - add_task
      - create_task
      - todo
    entities: {}  # No entity required
    situation:
      - environment_shipyard
  forbidden:
    - not_in_shipyard
  default_visibility: hidden
  explanation_template: "Add task to shipyard worklist"

export_worklist:
  tier: rare
  requires:
    intent:
      - export
      - download
      - report
      - print
    entities: {}
    situation:
      - environment_shipyard
      - user_is_hod
  forbidden:
    - not_in_shipyard
    - user_not_hod
  default_visibility: hidden
  explanation_template: "Export worklist report (HOD only)"

# =============================================================================
# META: VALIDATION RULES
# =============================================================================

_validation:
  rules:
    - name: no_show_always
      description: "No action may have default_visibility: always"
      check: "default_visibility != 'always'"

    - name: requires_entity_or_situation
      description: "Every action must require at least one entity or situation"
      check: "requires.entities.min OR requires.situation"

    - name: forbidden_not_empty
      description: "Every action must have at least one forbidden context"
      check: "forbidden.length > 0"

    - name: explanation_required
      description: "Every action must have an explanation template"
      check: "explanation_template != null"

_statistics:
  total_actions: 30
  tier_distribution:
    primary: 10
    conditional: 14
    rare: 6
  confirmation_required: 3
  auto_run: 1
