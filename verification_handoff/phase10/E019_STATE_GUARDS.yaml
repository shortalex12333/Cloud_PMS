# E019: STATE GUARDS
# Date: 2026-01-21
# Phase: 10 - Decision Policy Layer
# Status: LOCKED
#
# Rules:
# - Guards enforced server-side
# - UI reflects state, does not decide it
# - Mutual exclusion is non-negotiable

version: "1.0.0"
locked_at: "2026-01-21T12:00:00Z"

# =============================================================================
# WORK ORDER STATE MACHINE
# =============================================================================

work_order:
  states:
    - open
    - in_progress
    - completed
    - cancelled

  transitions:
    open:
      - to: in_progress
        action: start_work_order
      - to: cancelled
        action: cancel_work_order
        requires: user_is_hod

    in_progress:
      - to: completed
        action: close_work_order
      - to: cancelled
        action: cancel_work_order
        requires: user_is_hod

    completed:
      - to: in_progress
        action: reopen_work_order  # Not in 30, but defined for completeness
        requires: user_is_hod

    cancelled:
      # Terminal state - no transitions out

  state_guards:
    start_work_order:
      requires_state: open
      blocks:
        - close_work_order
        - cancel_work_order  # Can coexist but different outcomes

    close_work_order:
      requires_state: in_progress
      blocks:
        - start_work_order

    cancel_work_order:
      requires_state: [open, in_progress]
      requires: user_is_hod
      blocks:
        - close_work_order  # Can't close if cancelling

  # Actions allowed in each state
  state_allowed_actions:
    open:
      - start_work_order
      - cancel_work_order
      - view_work_order_detail
      - view_work_order_checklist
      - add_note_to_work_order
      - add_wo_note
      - update_work_order
      - assign_work_order

    in_progress:
      - close_work_order
      - cancel_work_order
      - view_work_order_detail
      - view_work_order_checklist
      - add_note_to_work_order
      - add_wo_note
      - add_wo_hours
      - add_wo_part
      - add_work_order_photo
      - add_parts_to_work_order
      - update_work_order
      - assign_work_order

    completed:
      - view_work_order_detail
      - view_work_order_checklist
      # No mutations allowed

    cancelled:
      - view_work_order_detail
      # No mutations allowed

# =============================================================================
# FAULT STATE MACHINE
# =============================================================================

fault:
  states:
    - reported
    - acknowledged
    - in_progress  # Has active work order
    - resolved
    - false_alarm

  transitions:
    reported:
      - to: acknowledged
        action: acknowledge_fault
      - to: false_alarm
        action: mark_fault_false_alarm
      - to: in_progress
        action: create_work_order_from_fault

    acknowledged:
      - to: in_progress
        action: create_work_order_from_fault
      - to: resolved
        action: close_fault
        requires: no_active_work_order
      - to: false_alarm
        action: mark_fault_false_alarm

    in_progress:
      - to: resolved
        action: close_fault
        requires: work_order_completed

    resolved:
      - to: reported
        action: reopen_fault

    false_alarm:
      # Terminal state - no transitions out

  state_guards:
    acknowledge_fault:
      requires_state: reported
      blocks:
        - close_fault  # Can't close before acknowledging

    close_fault:
      requires_state: [acknowledged, in_progress]
      requires: no_active_work_order
      blocks:
        - reopen_fault
        - mark_fault_false_alarm

    reopen_fault:
      requires_state: resolved
      blocks:
        - close_fault
        - mark_fault_false_alarm

    mark_fault_false_alarm:
      requires_state: [reported, acknowledged]
      blocks:
        - close_fault
        - create_work_order_from_fault

    create_work_order_from_fault:
      requires_state: [reported, acknowledged]
      requires: no_existing_work_order
      blocks:
        - mark_fault_false_alarm  # Can't dismiss if work scheduled

  # Actions allowed in each state
  state_allowed_actions:
    reported:
      - view_fault_detail
      - diagnose_fault
      - acknowledge_fault
      - update_fault
      - add_fault_photo
      - show_manual_section
      - create_work_order_from_fault
      - mark_fault_false_alarm
      - add_to_handover

    acknowledged:
      - view_fault_detail
      - diagnose_fault
      - update_fault
      - add_fault_photo
      - show_manual_section
      - create_work_order_from_fault
      - close_fault  # Only if no WO needed
      - mark_fault_false_alarm
      - add_to_handover

    in_progress:
      - view_fault_detail
      - diagnose_fault
      - update_fault
      - add_fault_photo
      - show_manual_section
      - add_to_handover
      # close_fault blocked until WO completes

    resolved:
      - view_fault_detail
      - reopen_fault

    false_alarm:
      - view_fault_detail
      # No other actions - terminal

# =============================================================================
# MUTUAL EXCLUSION RULES
# =============================================================================

mutual_exclusion:
  # These action pairs can NEVER both be visible at the same time
  rules:
    - actions: [start_work_order, close_work_order]
      reason: "Different states required"

    - actions: [close_fault, reopen_fault]
      reason: "Opposite state requirements"

    - actions: [close_fault, mark_fault_false_alarm]
      reason: "Both close the fault (different reasons)"

    - actions: [create_work_order_from_fault, close_fault]
      condition: "fault_has_active_work_order"
      reason: "Can't close fault with active WO"

    - actions: [acknowledge_fault, close_fault]
      condition: "fault_not_acknowledged"
      reason: "Must acknowledge before closing"

# =============================================================================
# IDEMPOTENCY GUARDS
# =============================================================================

idempotency:
  # Actions that should warn if attempted recently
  warn_on_repeat:
    - action: report_fault
      window_seconds: 300
      check: same_equipment_and_description
      message: "A similar fault was reported recently"

    - action: create_work_order
      window_seconds: 300
      check: same_equipment
      message: "A work order was recently created for this equipment"

    - action: add_to_handover
      window_seconds: 60
      check: same_entity
      message: "This item was just added to handover"

  # Actions that are naturally idempotent (can repeat safely)
  idempotent:
    - view_fault_detail
    - view_work_order_detail
    - view_work_order_checklist
    - view_worklist
    - diagnose_fault
    - show_manual_section

# =============================================================================
# ENFORCEMENT RULES
# =============================================================================

enforcement:
  # Where guards are checked
  check_points:
    - layer: server
      timing: before_execution
      behavior: reject_with_reason

    - layer: client
      timing: before_display
      behavior: hide_or_disable

  # Server-side is authoritative
  authority: server

  # Client may cache state for 30 seconds
  client_cache_ttl_seconds: 30

  # On state change, invalidate client cache
  invalidate_on:
    - work_order_status_change
    - fault_status_change
    - role_change

# =============================================================================
# VALIDATION
# =============================================================================

_validation:
  rules:
    - name: no_orphan_actions
      description: "Every action must appear in at least one state_allowed_actions"
      actions_to_check:
        - start_work_order
        - close_work_order
        - cancel_work_order
        - acknowledge_fault
        - close_fault
        - reopen_fault
        - mark_fault_false_alarm
        - create_work_order_from_fault

    - name: mutual_exclusion_complete
      description: "All competing state transitions have mutual exclusion rules"

    - name: terminal_states_have_no_mutations
      description: "Terminal states (cancelled, false_alarm) allow only view actions"

_statistics:
  work_order_states: 4
  work_order_transitions: 5
  fault_states: 5
  fault_transitions: 8
  mutual_exclusion_rules: 5
  idempotency_guards: 3
