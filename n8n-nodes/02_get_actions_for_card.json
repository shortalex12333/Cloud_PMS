{
  "parameters": {
    "jsCode": "// =============================================================================\n// GET ACTIONS FOR CARD\n// Assigns micro-actions based on card_type, intent, role, yacht_config\n// =============================================================================\n\n// Get catalogue from static data (set by previous node)\nconst ACTION_CATALOGUE = $workflow.staticData.ACTION_CATALOGUE;\nconst DEFAULT_ACTIONS_BY_CARD_TYPE = $workflow.staticData.DEFAULT_ACTIONS_BY_CARD_TYPE;\nconst CardType = $workflow.staticData.CardType;\nconst IntentType = $workflow.staticData.IntentType;\n\n/**\n * Get appropriate micro-actions for a card based on context\n * @param {string} cardType - Type of card\n * @param {string} intent - Detected search intent\n * @param {string} userRole - User's role\n * @param {object} yachtConfig - Yacht-specific feature flags\n * @param {object} metadata - Card metadata for building payloads\n * @param {number} maxActions - Maximum actions to return (default 4)\n * @returns {Array} List of MicroAction objects\n */\nfunction getActionsForCard(cardType, intent, userRole, yachtConfig = {}, metadata = {}, maxActions = 4) {\n  // Get candidate actions for this card type\n  const candidateActionIds = DEFAULT_ACTIONS_BY_CARD_TYPE[cardType] || [];\n  \n  // Score and filter actions\n  const scoredActions = [];\n  \n  for (const actionId of candidateActionIds) {\n    const actionDef = ACTION_CATALOGUE[actionId];\n    if (!actionDef) continue;\n    \n    // Check role permissions (empty = all roles allowed)\n    if (actionDef.allowedRoles.length > 0 && !actionDef.allowedRoles.includes(userRole)) {\n      continue;\n    }\n    \n    // Check feature requirements\n    if (actionDef.requiresFeature && !yachtConfig[actionDef.requiresFeature]) {\n      continue;\n    }\n    \n    // Calculate relevance score\n    let score = 1.0;\n    \n    // Boost if action matches intent\n    if (actionDef.boostedIntents.includes(intent)) {\n      score += 0.5;\n    }\n    \n    // Special case: suppress \"Create Work Order\" if intent is already create_work_order\n    if (actionId === 'create_work_order' && intent === IntentType.CREATE_WORK_ORDER) {\n      score -= 0.3;\n    }\n    \n    // Special case: boost \"Add to Handover\" if intent is add_to_handover\n    if (actionId === 'add_to_handover' && intent === IntentType.ADD_TO_HANDOVER) {\n      score += 1.0;\n    }\n    \n    scoredActions.push({ score, actionId });\n  }\n  \n  // Sort by score (descending) and take top N\n  scoredActions.sort((a, b) => b.score - a.score);\n  const selectedIds = scoredActions.slice(0, maxActions).map(a => a.actionId);\n  \n  // Build MicroAction objects with payloads\n  const actions = [];\n  for (const actionId of selectedIds) {\n    const action = buildMicroAction(actionId, cardType, metadata);\n    if (action) {\n      actions.push(action);\n    }\n  }\n  \n  return actions;\n}\n\n/**\n * Build a MicroAction with appropriate payload based on context\n */\nfunction buildMicroAction(actionId, cardType, metadata) {\n  const actionDef = ACTION_CATALOGUE[actionId];\n  if (!actionDef) return null;\n  \n  let payload = {};\n  \n  switch (actionId) {\n    case 'open_document':\n      payload = {\n        document_id: metadata.document_id,\n        page: metadata.page_number,\n        chunk_index: metadata.chunk_index\n      };\n      break;\n      \n    case 'download_document':\n      payload = {\n        document_id: metadata.document_id,\n        filename: metadata.filename\n      };\n      break;\n      \n    case 'view_equipment':\n      payload = { equipment_id: metadata.equipment_id };\n      break;\n      \n    case 'view_equipment_history':\n      payload = {\n        equipment_id: metadata.equipment_id,\n        filter: 'all'\n      };\n      break;\n      \n    case 'create_work_order':\n      payload = {\n        equipment_id: metadata.equipment_id,\n        fault_code: metadata.fault_code,\n        prefill_title: generateWorkOrderTitle(metadata)\n      };\n      break;\n      \n    case 'show_predictive_insight':\n      payload = { equipment_id: metadata.equipment_id };\n      break;\n      \n    case 'view_fault_details':\n      payload = { fault_id: metadata.fault_id || metadata.id };\n      break;\n      \n    case 'find_related_manual':\n      payload = {\n        equipment_id: metadata.equipment_id,\n        fault_code: metadata.fault_code,\n        search_type: 'related_documentation'\n      };\n      break;\n      \n    case 'view_fault_history':\n      payload = {\n        equipment_id: metadata.equipment_id,\n        fault_code: metadata.fault_code\n      };\n      break;\n      \n    case 'view_part_stock':\n      payload = { part_id: metadata.part_id || metadata.id };\n      break;\n      \n    case 'order_part':\n      payload = {\n        part_id: metadata.part_id || metadata.id,\n        part_number: metadata.part_number,\n        current_stock: metadata.stock_level || 0\n      };\n      break;\n      \n    case 'add_part_to_work_order':\n      payload = {\n        part_id: metadata.part_id || metadata.id,\n        part_number: metadata.part_number\n      };\n      break;\n      \n    case 'find_substitute':\n      payload = {\n        part_id: metadata.part_id || metadata.id,\n        part_number: metadata.part_number\n      };\n      break;\n      \n    case 'view_work_order':\n      payload = { work_order_id: metadata.work_order_id || metadata.id };\n      break;\n      \n    case 'clone_work_order':\n      payload = { source_work_order_id: metadata.work_order_id || metadata.id };\n      break;\n      \n    case 'view_handover':\n      payload = { handover_id: metadata.handover_id || metadata.id };\n      break;\n      \n    case 'add_to_handover':\n      payload = {\n        source_type: cardType,\n        source_id: metadata.id,\n        title: metadata.title || ''\n      };\n      break;\n      \n    case 'copy_link':\n      payload = {\n        entity_type: cardType,\n        entity_id: metadata.id\n      };\n      break;\n      \n    case 'copy_snippet':\n      payload = { text: metadata.snippet || '' };\n      break;\n  }\n  \n  // Remove null/undefined values\n  payload = Object.fromEntries(Object.entries(payload).filter(([_, v]) => v != null));\n  \n  return {\n    id: actionDef.id,\n    label: actionDef.label,\n    icon: actionDef.icon,\n    action_type: actionDef.actionType,\n    payload: payload,\n    requires_confirmation: actionDef.requiresConfirmation\n  };\n}\n\n/**\n * Generate a prefilled work order title from metadata\n */\nfunction generateWorkOrderTitle(metadata) {\n  if (metadata.fault_code) {\n    return `Fix fault ${metadata.fault_code}`;\n  } else if (metadata.equipment_name) {\n    return `Work on ${metadata.equipment_name}`;\n  }\n  return 'New work order';\n}\n\n// Store function in static data for use by card generator\n$workflow.staticData.getActionsForCard = getActionsForCard;\n\nreturn [{ json: { status: 'getActionsForCard function loaded' } }];"
  },
  "name": "Get Actions For Card",
  "type": "n8n-nodes-base.code",
  "typeVersion": 2,
  "position": [220, 0]
}
