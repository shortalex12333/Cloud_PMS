{
  "parameters": {
    "jsCode": "// =============================================================================\n// CARD GENERATOR\n// Converts RAG results into canonical SearchResultCard objects\n// =============================================================================\n\n// Get dependencies from static data\nconst CardType = $workflow.staticData.CardType;\nconst getActionsForCard = $workflow.staticData.getActionsForCard;\n\n/**\n * Map result type string to CardType\n */\nfunction mapToCardType(resultType) {\n  const mapping = {\n    'document_chunk': CardType.DOCUMENT,\n    'document': CardType.DOCUMENT,\n    'fault': CardType.FAULT,\n    'work_order': CardType.WORK_ORDER,\n    'part': CardType.PART,\n    'equipment': CardType.EQUIPMENT,\n    'predictive': CardType.PREDICTIVE,\n    'handover': CardType.HANDOVER,\n    'email': CardType.DOCUMENT,\n    'note': CardType.NOTE\n  };\n  return mapping[resultType] || CardType.DOCUMENT;\n}\n\n/**\n * Map role string to standard role\n */\nfunction mapRoleString(roleStr) {\n  const roleLower = (roleStr || '').toLowerCase();\n  if (roleLower.includes('chief')) return 'Chief Engineer';\n  if (roleLower.includes('hod')) return 'HOD';\n  if (roleLower.includes('eto')) return 'ETO';\n  if (roleLower.includes('engineer')) return 'Engineer';\n  if (roleLower.includes('deck')) return 'Deck Officer';\n  if (roleLower.includes('captain')) return 'Captain';\n  if (roleLower.includes('viewer')) return 'Viewer';\n  return 'Engineer';\n}\n\n/**\n * Build metadata from result data\n */\nfunction buildMetadata(result, data, cardType) {\n  const metadata = {\n    id: result.id || data.id,\n    similarity_score: result.similarity,\n    is_global_knowledge: result.is_global || false\n  };\n  \n  switch (cardType) {\n    case CardType.DOCUMENT:\n      metadata.document_id = data.document_id || result.id;\n      metadata.page_number = data.page_number;\n      metadata.chunk_index = data.chunk_index;\n      if (data.document) {\n        metadata.filename = data.document.filename;\n        metadata.document_type = data.document.document_type;\n      }\n      if (data.equipment_ids && data.equipment_ids.length > 0) {\n        metadata.equipment_id = data.equipment_ids[0];\n      }\n      break;\n      \n    case CardType.FAULT:\n      metadata.fault_id = data.id;\n      metadata.fault_code = data.fault_code;\n      metadata.equipment_id = data.equipment_id;\n      metadata.severity = data.severity;\n      metadata.detected_at = data.detected_at;\n      metadata.resolved_at = data.resolved_at;\n      if (data.equipment) {\n        metadata.equipment_name = data.equipment.name;\n      }\n      break;\n      \n    case CardType.WORK_ORDER:\n      metadata.work_order_id = data.work_order_id || data.id;\n      metadata.equipment_id = data.equipment_id;\n      metadata.work_order_status = data.status_on_completion || data.status;\n      metadata.completed_at = data.completed_at;\n      metadata.assigned_to = data.assigned_to;\n      if (data.work_order) {\n        metadata.work_order_id = data.work_order.id;\n        metadata.work_order_status = data.work_order.status;\n      }\n      break;\n      \n    case CardType.PART:\n      metadata.part_id = data.id;\n      metadata.part_number = data.part_number;\n      metadata.manufacturer = data.manufacturer;\n      if (data.stock_levels && Array.isArray(data.stock_levels)) {\n        metadata.stock_level = data.stock_levels.reduce((sum, s) => sum + (s.quantity || 0), 0);\n        if (data.stock_levels[0] && data.stock_levels[0].location) {\n          metadata.stock_location = data.stock_levels[0].location.name;\n        }\n      }\n      break;\n      \n    case CardType.EQUIPMENT:\n      metadata.equipment_id = data.id;\n      metadata.equipment_name = data.name;\n      metadata.equipment_code = data.code;\n      metadata.manufacturer = data.manufacturer;\n      metadata.model = data.model;\n      metadata.location = data.location;\n      metadata.criticality = data.criticality;\n      metadata.system_type = data.system_type;\n      break;\n      \n    case CardType.PREDICTIVE:\n      metadata.equipment_id = data.equipment_id;\n      metadata.prediction_confidence = data.confidence;\n      metadata.predicted_failure_window = data.failure_window;\n      metadata.risk_level = data.risk_level;\n      break;\n      \n    case CardType.HANDOVER:\n      metadata.handover_id = data.id;\n      metadata.shift_date = data.shift_date;\n      metadata.author = data.author;\n      break;\n      \n    case CardType.NOTE:\n      metadata.note_id = data.id;\n      metadata.note_type = data.note_type;\n      metadata.created_by = data.created_by;\n      break;\n  }\n  \n  return metadata;\n}\n\n/**\n * Build source label from result data\n */\nfunction buildSourceLabel(result, data, cardType) {\n  // Check if already has source_label\n  if (result.source_label) {\n    return {\n      source_type: result.source_label.source_type || 'Unknown',\n      source_name: result.source_label.source_name || '',\n      location: result.source_label.location || null\n    };\n  }\n  \n  switch (cardType) {\n    case CardType.DOCUMENT:\n      let docType = 'Document';\n      let sourceName = '';\n      let location = null;\n      \n      if (data.document) {\n        const dtype = (data.document.document_type || '').toLowerCase();\n        if (dtype.includes('manual')) docType = 'Manual';\n        else if (dtype.includes('bulletin')) docType = 'Tech Bulletin';\n        else if (dtype.includes('email')) docType = 'Email';\n        sourceName = data.document.filename || '';\n      }\n      if (data.page_number) {\n        location = `Page ${data.page_number}`;\n      }\n      return { source_type: docType, source_name: sourceName, location };\n      \n    case CardType.FAULT:\n      return {\n        source_type: 'Fault Log',\n        source_name: data.fault_code || '',\n        location: data.detected_at ? data.detected_at.substring(0, 10) : null\n      };\n      \n    case CardType.WORK_ORDER:\n      return {\n        source_type: 'Work Order',\n        source_name: data.work_order_id ? data.work_order_id.substring(0, 8) : '',\n        location: null\n      };\n      \n    case CardType.PART:\n      return {\n        source_type: 'Parts Inventory',\n        source_name: data.part_number || '',\n        location: null\n      };\n      \n    case CardType.EQUIPMENT:\n      return {\n        source_type: 'Equipment',\n        source_name: data.code || data.name || '',\n        location: data.location || null\n      };\n      \n    case CardType.PREDICTIVE:\n      return { source_type: 'Predictive', source_name: 'Analysis', location: null };\n      \n    case CardType.HANDOVER:\n      return { source_type: 'Handover', source_name: data.shift_date || '', location: null };\n      \n    case CardType.NOTE:\n      return { source_type: 'Note', source_name: data.note_type || '', location: null };\n      \n    default:\n      return { source_type: result.source || 'Unknown', source_name: '', location: null };\n  }\n}\n\n/**\n * Create a single SearchResultCard from a fused result\n */\nfunction createCard(result, intent, userRole, yachtConfig) {\n  const resultType = result.type || 'document_chunk';\n  const data = result.data || {};\n  \n  // Map to card type\n  const cardType = mapToCardType(resultType);\n  \n  // Build metadata\n  const metadata = buildMetadata(result, data, cardType);\n  \n  // Build source label\n  const sourceLabel = buildSourceLabel(result, data, cardType);\n  \n  // Get title and snippet\n  const title = (result.title || 'Result').substring(0, 100);\n  const snippet = (result.preview || '').substring(0, 300);\n  \n  // Get relevance score\n  const relevanceScore = result.final_score || result.similarity || 0.5;\n  \n  // Get micro-actions\n  const role = mapRoleString(userRole);\n  const actions = getActionsForCard(cardType, intent, role, yachtConfig, { ...metadata, title, snippet }, 4);\n  \n  // Build graph context if applicable\n  let graphContext = null;\n  if (result.source_type === 'graph' || result.graph_context) {\n    graphContext = {\n      discovered_via: result.source || 'graph',\n      depth: (result.data || {}).depth || 0\n    };\n  }\n  \n  return {\n    card_type: cardType,\n    title: title,\n    snippet: snippet,\n    source_label: sourceLabel,\n    metadata: metadata,\n    actions: actions,\n    relevance_score: relevanceScore,\n    graph_context: graphContext\n  };\n}\n\n/**\n * Generate cards from fused results\n */\nfunction generateCards(fusedResults, intent, userRole, yachtConfig) {\n  const cards = [];\n  \n  for (const result of fusedResults) {\n    try {\n      const card = createCard(result, intent, userRole, yachtConfig);\n      cards.push(card);\n    } catch (e) {\n      console.error('Failed to create card:', e);\n    }\n  }\n  \n  return cards;\n}\n\n// Store function in static data\n$workflow.staticData.generateCards = generateCards;\n$workflow.staticData.createCard = createCard;\n\nreturn [{ json: { status: 'Card generator loaded' } }];"
  },
  "name": "Card Generator",
  "type": "n8n-nodes-base.code",
  "typeVersion": 2,
  "position": [440, 0]
}
