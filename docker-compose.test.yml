# Local test environment for Certificate RLS validation
# Usage: docker-compose -f docker-compose.test.yml up --build

services:
  api:
    build:
      context: ./apps/api
      dockerfile: Dockerfile
    ports:
      - "8889:8000"
    environment:
      # MASTER Supabase (auth/user lookup)
      - MASTER_SUPABASE_URL=https://qvzmkaamzaqxpzbewjxe.supabase.co
      - MASTER_SUPABASE_SERVICE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF2em1rYWFtemFxeHB6YmV3anhlIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2Mzk3OTA0NiwiZXhwIjoyMDc5NTU1MDQ2fQ.83Bc6rEQl4qNf0MUwJPmMl1n0mhqEo6nVe5fBiRmh8Q
      - MASTER_SUPABASE_JWT_SECRET=wXka4UZu4tZc8Sx/HsoMBXu/L5avLHl+xoiWAH9lBbxJdbztPhYVc+stfrJOS/mlqF3U37HUkrkAMOhkpwjRsw==
      # TENANT Supabase (yacht data)
      - yTEST_YACHT_001_SUPABASE_URL=https://vzsohavtuotocgrfkfyd.supabase.co
      - yTEST_YACHT_001_SUPABASE_SERVICE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ6c29oYXZ0dW90b2NncmZrZnlkIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2MzU5Mjg3NSwiZXhwIjoyMDc5MTY4ODc1fQ.fC7eC_4xGnCHIebPzfaJ18pFMPKgImE7BuN0I3A-pSY
      - DEFAULT_YACHT_CODE=yTEST_YACHT_001
      # Feature flags
      - FEATURE_CERTIFICATES=true
      # Logging
      - LOG_LEVEL=INFO
      - PYTHONUNBUFFERED=1
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/health')"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s

  test-runner:
    build:
      context: ./tests/docker
      dockerfile: Dockerfile.test
    depends_on:
      api:
        condition: service_healthy
    environment:
      - API_BASE=http://api:8000
      - MASTER_SUPABASE_URL=https://qvzmkaamzaqxpzbewjxe.supabase.co
      - MASTER_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF2em1rYWFtemFxeHB6YmV3anhlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM5NzkwNDYsImV4cCI6MjA3OTU1NTA0Nn0.MMzzsRkvbug-u19GBUnD0qLDtMVWEbOf6KE8mAADaxw
      - YACHT_ID=85fe1119-b04c-41ac-80f1-829d23322598
      - CREW_EMAIL=crew.test@alex-short.com
      - HOD_EMAIL=hod.test@alex-short.com
      - CAPTAIN_EMAIL=captain.test@alex-short.com
      - TEST_PASSWORD=Password2!
