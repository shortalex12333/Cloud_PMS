# Prefill Engine - Quick Reference Card

## 30-Second Overview

The prefill engine auto-populates mutation fields from NLP-extracted entities using declarative `FieldMetadata` rules.

**Two phases:**
1. `/prepare`: Returns preview with auto-filled values
2. `/commit`: Executes mutation after validation

## Minimal Example

```python
from common import FieldMetadata, build_mutation_preview

# 1. Define field metadata (once per mutation type)
FIELD_METADATA = {
    "yacht_id": FieldMetadata(
        name="yacht_id",
        classification="CONTEXT",  # Auto-populated from auth
    ),
    "equipment_id": FieldMetadata(
        name="equipment_id",
        classification="REQUIRED",
        auto_populate_from="equipment",  # Extract from NLP
        lookup_required=True,             # Resolve to UUID
    ),
    "title": FieldMetadata(
        name="title",
        classification="BACKEND_AUTO",
        compose_template="{equipment} - {symptom}",  # Compose
    ),
    "priority": FieldMetadata(
        name="priority",
        classification="OPTIONAL",
        value_map={"urgent": "critical"},  # Translate
        default="medium",                   # Default
    ),
}

# 2. Build preview (in /prepare endpoint)
preview = await build_mutation_preview(
    query_text="create urgent work order for main engine overheating",
    extracted_entities={"equipment": "main engine", "symptom": "overheating"},
    field_metadata=FIELD_METADATA,
    yacht_id="yacht-123",
    supabase_client=client,
)

# 3. Check result
if preview["ready_to_commit"]:
    # All fields populated - ready for /commit
    mutation = preview["mutation_preview"]
else:
    # Show form with missing/ambiguous fields
    show_form(
        preview=preview["mutation_preview"],
        missing=preview["missing_required"],
        dropdowns=preview["dropdown_options"],
    )
```

## Field Classifications

| Classification | Purpose | Example |
|---|---|---|
| `REQUIRED` | Must be provided by user or NLP | `equipment_id` |
| `OPTIONAL` | May be provided, has default | `priority` |
| `BACKEND_AUTO` | Generated by system | `id`, `created_at`, composed values |
| `CONTEXT` | From auth/session | `yacht_id`, `user_id` |

## FieldMetadata Properties

| Property | Type | Purpose | Example |
|---|---|---|---|
| `classification` | Literal | Field type | `"REQUIRED"` |
| `auto_populate_from` | str | Entity to extract | `"equipment"` |
| `compose_template` | str | Multi-entity template | `"{equipment} - {symptom}"` |
| `lookup_required` | bool | Resolve to UUID | `True` |
| `value_map` | Dict | Translate values | `{"urgent": "critical"}` |
| `default` | Any | Default value | `"medium"` |
| `options` | List | Enum options | `["low", "medium", "high"]` |

## Entity Types

Common values for `auto_populate_from`:
- `"equipment"`: EQUIPMENT_NAME entity
- `"symptom"`: SYMPTOM entity
- `"query_text"`: Raw query text
- `"part"`: PART_NAME or PART_NUMBER entity
- `"fault"`: FAULT_CODE entity
- `"work_order"`: WORK_ORDER_ID entity

## Lookup Behavior

```python
# Lookup returns:
# - Single match: value = "uuid"
# - Multiple matches: options = [{id, name, ...}]
# - No matches: value = None
```

| Matches | Result | Action |
|---|---|---|
| 0 | `count=0, value=None` | Warning + missing_required |
| 1 | `count=1, value="uuid"` | Auto-populated |
| 2+ | `count=N, options=[...]` | Dropdown for user selection |

## Preview Response Structure

```python
{
    "mutation_preview": {          # Auto-populated values
        "equipment_id": "uuid-...",
        "title": "main engine - overheating",
        "priority": "critical",
    },
    "missing_required": [],        # Missing REQUIRED fields
    "warnings": [],                # Warnings (ambiguous, missing)
    "dropdown_options": {},        # Options for ambiguous lookups
    "ready_to_commit": True,       # Ready for /commit?
}
```

## Common Patterns

### Pattern 1: UUID Lookup
```python
FieldMetadata(
    name="equipment_id",
    classification="REQUIRED",
    auto_populate_from="equipment",
    lookup_required=True,
)
# "main engine" → lookup → "uuid-123"
```

### Pattern 2: Composed Value
```python
FieldMetadata(
    name="title",
    classification="BACKEND_AUTO",
    compose_template="{equipment} - {symptom}",
)
# {equipment: "main engine", symptom: "overheating"}
# → "main engine - overheating"
```

### Pattern 3: Value Mapping
```python
FieldMetadata(
    name="priority",
    classification="OPTIONAL",
    value_map={"urgent": "critical", "asap": "critical"},
    default="medium",
)
# "urgent" → "critical"
```

### Pattern 4: Context Field
```python
FieldMetadata(
    name="yacht_id",
    classification="CONTEXT",
)
# Auto-populated from auth context
```

### Pattern 5: Backend Generated
```python
FieldMetadata(
    name="id",
    classification="BACKEND_AUTO",
)
# Auto-generated UUID
```

## Endpoint Template

```python
@router.post("/v1/my-entity/prepare")
async def prepare(request: PrepareRequest):
    preview = await build_mutation_preview(
        query_text=request.query_text,
        extracted_entities=await extract_entities(request.query_text),
        field_metadata=MY_FIELD_METADATA,
        yacht_id=request.yacht_id,
        supabase_client=get_supabase_client(),
        user_id=request.user_id,
    )
    return preview

@router.post("/v1/my-entity/commit")
async def commit(request: CommitRequest):
    validation = validate_mutation_preview(
        request.mutation_preview, MY_FIELD_METADATA
    )
    if not validation["valid"]:
        raise HTTPException(400, validation["errors"])

    result = supabase.table("my_table").insert(
        request.mutation_preview
    ).execute()
    return result
```

## Available Lookups

| Function | Purpose | Example |
|---|---|---|
| `lookup_equipment_by_name()` | Equipment name → UUID | `"main engine"` → `"uuid"` |
| `lookup_fault_by_symptom()` | Symptom → fault UUID | `"overheating"` → `"uuid"` |
| `lookup_part_by_name()` | Part name → UUID | `"oil filter"` → `"uuid"` |
| `lookup_work_order_by_number()` | WO number → UUID | `"WO-123"` → `"uuid"` |
| `lookup_entity()` | Generic router | Auto-dispatches |

## Error Handling

The engine returns **warnings** instead of **errors**:

```python
# Missing entity
warnings: ["No match found for equipment_id: 'xyz'"]
missing_required: ["equipment_id"]
ready_to_commit: False

# Ambiguous entity
warnings: ["Ambiguous equipment_id: 'engine' matched 3 items"]
dropdown_options: {"equipment_id": [{id: "...", name: "main engine"}, ...]}
ready_to_commit: False

# Lookup failure
warnings: ["Lookup failed for equipment_id: Connection timeout"]
missing_required: ["equipment_id"]
ready_to_commit: False
```

## Testing

```python
# Unit test
from common import build_mutation_preview

preview = await build_mutation_preview(...)
assert preview["ready_to_commit"] == True
assert preview["mutation_preview"]["priority"] == "critical"

# Run tests
pytest apps/api/common/test_prefill_engine.py -v
```

## Validation

```python
from common import validate_mutation_preview

validation = validate_mutation_preview(
    mutation_preview=preview["mutation_preview"],
    field_metadata=FIELD_METADATA
)

if validation["valid"]:
    # Execute mutation
else:
    # Return errors
    raise HTTPException(400, validation["errors"])
```

## Performance

Expected latency:
- Preview build (no lookups): **1-5ms**
- Preview build (1 lookup): **20-50ms**
- Preview build (3 lookups): **50-150ms**
- Commit: **20-50ms**

**Total:** 100-300ms for complete /prepare → /commit flow

## Common Issues

| Issue | Solution |
|---|---|
| "lookup_required requires auto_populate_from" | Add `auto_populate_from` property |
| "compose_template requires auto_populate_from" | Add `auto_populate_from` property |
| "BACKEND_AUTO requires source" | Add `auto_populate_from` or `default` |
| Lookup returns 0 matches | Check entity extraction, verify data in DB |
| Lookup returns 2+ matches | Normal - show dropdown to user |

## Files & Documentation

| File | Purpose |
|---|---|
| `field_metadata.py` | FieldMetadata schema |
| `lookup_functions.py` | Yacht-scoped lookups |
| `prefill_engine.py` | Core preview builder |
| `prefill_examples.py` | Real-world examples |
| `test_prefill_engine.py` | Unit tests |
| `README.md` | Full documentation |
| `ARCHITECTURE.md` | System architecture |
| `INTEGRATION_EXAMPLE.md` | Complete endpoint example |

## Next Steps

1. Define field metadata for your mutation
2. Create `/prepare` endpoint
3. Create `/commit` endpoint
4. Test with real data
5. Add to action registry

See `INTEGRATION_EXAMPLE.md` for complete implementation.
